!function(t,e,r){function n(e){var r=t.url.parse(location.href).params;return r&&r[e]}return e.extend(r,{Controller:r.Base.extend({constructor:function(t){this.viewModel=t&&t.viewModel?t.viewModel:new r.ViewModel,this.dataTransfer=t&&t.dataTransfer?t.dataTransfer:new r.DataTransfer({dataConverter:new r.DataConverter}),this.initialize(t),r.listen({"viewmodel:selection:changed":e.bind(function(t,e,r,n){e&&n&&this.updateControlsValues(e,r)},this),"reportoptions:selection:changed":e.bind(function(t,e){this.reset(e&&e.uri)},this)}),r.getController=e.bind(function(){return this},this),e.bindAll(this)},initialize:function(t){this.dataTransfer.setReportUri(this.detectReportUri(t))},fetchControlsStructure:function(t,r){var n=this.dataTransfer,i=this.viewModel,o=r&&!e.isEmpty(t)?e.keys(t):[];return n.fetchControlsStructure(o,t).done(function(t){t&&i.set({structure:t.structure,state:t.state})})},detectReportUri:function(t){if(this.reportUri=t&&t.reportUri||n("reportUnitURI"),!this.reportUri)throw Error("Can't initialize without reportUri");return this.reportOptionUri=t&&t.reportOptionUri||n("reportOptionsURI"),this.getReportUri()},getReportUri:function(){return this.reportOptionUri||this.reportUri},getDataTransfer:function(){return this.dataTransfer},getViewModel:function(){return this.viewModel},updateControlsValues:function(t,r){var n=this.getDataTransfer(),i=this.getViewModel(),o=r||e.map(i.getControls(),function(t){return t.id});return n.fetchControlsUpdatedValues(o,t).done(i.set)},reset:function(t){return this.getDataTransfer().fetchInitialControlValues(t||this.getReportUri()).done(this.getViewModel().set)},update:function(t){return t||(t=this.getViewModel().get("selection")),this.updateControlsValues(t)},validate:function(){var t=this.getDataTransfer(),r=this.getViewModel(),n=e.map(r.getControls(),function(t){return t.id}),i=r.get("selection");return t.fetchControlsUpdatedValues(n,i).then(function(t){var n=e(t.state).reduce(function(t,e,r){return t[r]={error:e.error},t},{});r.set({state:n})}).then(function(){return r.areAllControlsValid()})}})})}(jQuery,_,JRS.Controls);