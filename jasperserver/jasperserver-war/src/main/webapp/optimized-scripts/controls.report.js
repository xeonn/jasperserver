var Controls=function(o,e,t,n){return e.extend(t,{_messages:{},layouts:{LAYOUT_POPUP_SCREEN:1,LAYOUT_SEPARATE_PAGE:2,LAYOUT_TOP_OF_PAGE:3,LAYOUT_IN_PAGE:4},controlDialog:null,reportOptionsDialog:null,inputControlsLocation:null,toggleControlsOn:!1,controller:null,hideControls:null,selectionChanged:!0,initialize:function(){this.controller=new JRS.Controls.Controller({reportUri:n.reportUnitURI,reportOptionUri:n.reportOptionsURI});var r=e.extend(n.getAllRequestParameters(),n.reportParameterValues);this.controller.fetchControlsStructure(r).always(function(r){var s=t.controller.getViewModel(),l=s.areAllControlsValid(),a=!e.isUndefined(e.find(n.parametersWithoutDefaultValues,function(o){return!e.contains(e.keys(n.getAllRequestParameters()),o)}));n.hasInputControls&&((n.reportForceControls||a)&&e.isEmpty(n.reportParameterValues)||!l)?((!r||"number"!=typeof r.status||r.status<300)&&t.show(),n&&n.nothingToDisplay&&(n.nothingToDisplay.removeClassName(layoutModule.HIDDEN_CLASS),centerElement(n.nothingToDisplay,{horz:!0,vert:!0}),o("#"+n.DATA_REFRESH_BUTTON).attr(layoutModule.DISABLED_ATTR_NAME,layoutModule.DISABLED_ATTR_NAME)),t.lastSelection=s.get("selection")):t.refreshReport(),JRS.Controls.listen({"viewmodel:selection:changed":function(){t.selectionChanged=!0},"reportoptions:selection:changed":function(){t.selectionChanged=!0}})}),this.viewModel=t.controller.getViewModel(),this.initializeOptions(),this.buttonActions={"button#ok":e.bind(t.applyInputValues,t,!0),"button#apply":e.bind(t.applyInputValues,t),"button#cancel":e.bind(t.cancel,t),"button#reset":t.resetToInitial,"button#save":t.save,"button#remove":t.remove};var s={"button#ok":e.bind(t.applyInputValues,t,!0),"button#cancel":e.bind(t.cancel,t),"button#reset":t.resetToInitial,"button#apply":e.bind(t.applyInputValues,t),"button#save":t.save,"button#remove":t.remove};$(ControlsBase.INPUT_CONTROLS_DIALOG)&&(this.controlDialog=new ControlDialog(s)),$(ControlsBase.INPUT_CONTROLS_FORM)&&$(ControlsBase.INPUT_CONTROLS_FORM).observe("click",function(o){var e=o.element();for(var t in this.buttonActions)if(matchAny(e,[t],!0))return this.buttonActions[t](),void o.stop()}.bindAsEventListener(this)),this.inputControlsLocation=$($(ControlsBase.INPUT_CONTROLS_CONTAINER)?ControlsBase.INPUT_CONTROLS_CONTAINER:ControlsBase.INPUT_CONTROLS_FORM),$(ControlsBase.TOOLBAR_CONTROLS_BUTTON)&&(this.toggleControlsOn=$(ControlsBase.TOOLBAR_CONTROLS_BUTTON).hasClassName("down"))},initializeOptions:function(){function r(){var e;e=o(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_DIALOG:"#"+ControlsBase.INPUT_CONTROLS_FORM),e&&e.length>0&&e.addClass("showingSubHeader")}function s(){var e;e=o(t.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_DIALOG:"#"+ControlsBase.INPUT_CONTROLS_FORM),e&&e.length>0&&e.removeClass("showingSubHeader")}if(isProVersion()){var l;l=this.layouts.LAYOUT_POPUP_SCREEN==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_DIALOG+" .sub.header":this.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout?"#"+ControlsBase.INPUT_CONTROLS_FORM+" .sub.header":"#"+ControlsBase.INPUT_CONTROLS_FORM+" .sub.header";var a=new JRS.Controls.ReportOptions;a.fetch(n.reportUnitURI,n.reportOptionsURI).done(function(){o(l).append(a.getElem()),t.lastReportOptionsSelection=a.get("selection")}).fail(function(){o(l).addClass("hidden")}).always(function(){t.lastReportOptionsSelection||(t.lastReportOptionsSelection=a.get("defaultOption"))}),a.updateWarningMessage=function(){t.reportOptionsDialog.showWarning(this.error)},JRS.Controls.listen({"viewmodel:selection:changed":function(){var o=a.find({uri:n.reportUnitURI});a.set({selection:o},!0)},"viewmodel:order:changed":e.bind(function(o,t){n.newIcOrder=e.pluck(t,"id").join(";")},this)});var i={"button#saveAsBtnSave":function(){var e=t.reportOptionsDialog.input.getValue(),s=t.viewModel.get("selection"),i=e===t.reportOptionsDialog.optionNameToOverwrite;a.add(n.reportUnitURI,e,s,i).done(function(){t.reportOptionsDialog.hideWarning(),dialogs.systemConfirm.show(ControlsBase.getMessage("report.options.option.saved")),r();var e=a.getElem().parent();e.length>0?e.removeClass("hidden"):(o(l).removeClass("hidden"),o(l).append(a.getElem())),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&o("#"+ControlsBase.INPUT_CONTROLS_FORM+" .header").removeClass("hidden"),t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}).fail(function(n){if(n)try{var r=o.parseJSON(n.responseText);"report.options.dialog.confirm.message"===r.errorCode&&!i&&(t.reportOptionsDialog.optionNameToOverwrite=e)}catch(s){}})},"button#saveAsBtnCancel":function(){t.reportOptionsDialog.hide(),delete t.reportOptionsDialog.optionNameToOverwrite}};$(ControlsBase.SAVE_REPORT_OPTIONS_DIALOG)&&(this.reportOptionsDialog=new OptionsDialog(i)),this.remove=function(){var e=a.get("selection").label;confirm(ControlsBase.getMessage("report.options.option.confirm.remove",{option:e}))&&a.removeOption(n.reportUnitURI,e).done(function(){if(!a.get("values")){s();var e=a.getElem().parent();e.length>0?e.addClass("hidden"):(o(l).addClass("hidden"),o(l).innerHTML=""),t.layouts.LAYOUT_TOP_OF_PAGE==n.reportControlsLayout&&o("#"+ControlsBase.INPUT_CONTROLS_FORM+" .header").addClass("hidden")}a.enableRemoveButton(!1),dialogs.systemConfirm.show(ControlsBase.getMessage("report.options.option.removed"))})},t.reportOptions=a}},cancel:function(){n.reportControlsLayout==t.layouts.LAYOUT_SEPARATE_PAGE&&t.separatePageICLayoutFirstShow?n.goBack():t.controller.update(t.lastSelection).always(function(){n.reportControlsLayout==t.layouts.LAYOUT_POPUP_SCREEN?t.controlDialog.hide():n.reportControlsLayout==t.layouts.LAYOUT_SEPARATE_PAGE&&t.showReport(),t.reportOptions&&t.lastReportOptionsSelection&&t.reportOptions.set({selection:t.lastReportOptionsSelection},!0)})},save:function(){t.selectionChanged?t.controller.validate().then(t.showOptionDialog):t.showOptionDialog()},refreshReport:function(o){var r=t.viewModel.get("selection");if(o){var s=JRS.Controls.ViewModel.isSelectionChanged(t.lastSelection,r);if(!s)return}try{r&&!e.isEmpty(r)?(n.refreshReport(null,null,ControlsBase.buildSelectedDataUri(r)),t.lastSelection=r):(n.refreshReport(),t.lastSelection={})}catch(l){alert(l)}},applyInputValues:function(o){var e=t.viewModel;t.selectionChanged?t.controller.validate().then(function(e){e&&(t.refreshReport(),o&&t.hide(),t.reportOptions&&(t.lastReportOptionsSelection=t.reportOptions.get("selection"))),t.selectionChanged=!1}):e.areAllControlsValid()&&o&&t.hide()},resetToInitial:function(){t.selectionChanged=!0;var o=t.reportOptions;if(o){var e=o.find({uri:n.reportOptionsURI?n.reportOptionsURI:n.reportUnitURI});if(e)return void o.set({selection:e})}t.controller.reset()},show:function(){switch(n.reportControlsLayout){case 2:t.showControls();break;case 3:t.toggleControls();break;case 4:break;default:t.showDialog()}},hide:function(){switch(n.reportControlsLayout){case 2:t.showReport();break;case 3:break;case 4:break;default:t.controlDialog.hide()}},toggleControls:function(){t.toggleControlsOn?($(ControlsBase.TOOLBAR_CONTROLS_BUTTON).removeClassName("down").addClassName("up"),$$(".panel.pane.inputControls")[0].addClassName(layoutModule.HIDDEN_CLASS),triggerNativeEvent("resize")):($(ControlsBase.TOOLBAR_CONTROLS_BUTTON).removeClassName("up").addClassName("down"),$$(".panel.pane.inputControls")[0].removeClassName(layoutModule.HIDDEN_CLASS)),t.toggleControlsOn=!t.toggleControlsOn,isIPad()&&n.touchController.reset(),o("#"+ControlsBase.INPUT_CONTROLS_FORM).show().height()},showDialog:function(){t.controlDialog&&t.controlDialog.show()},showReport:function(){$(layoutModule.PAGE_BODY_ID).removeClassName(layoutModule.CONTROL_PAGE_CLASS).addClassName(layoutModule.ONE_COLUMN_CLASS)},showControls:function(){$(layoutModule.PAGE_BODY_ID).removeClassName(layoutModule.ONE_COLUMN_CLASS).addClassName(layoutModule.CONTROL_PAGE_CLASS),document.getElementById(ControlsBase.INPUT_CONTROLS_FORM)&&o("#"+ControlsBase.INPUT_CONTROLS_FORM).show()},showOptionDialog:function(){JRS.Controls.Utils.wait(200).then(function(){t.viewModel.areAllControlsValid()&&(t.reportOptionsDialog.show(),selectAndFocusOn(t.reportOptionsDialog.input))})}})}(jQuery,_,{},Report);