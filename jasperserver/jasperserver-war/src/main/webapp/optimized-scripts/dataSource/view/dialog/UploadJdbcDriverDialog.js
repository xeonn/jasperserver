define(["require","dataSource/view/dialog/BaseDialog","underscore","jquery","common/transport/AjaxFormSubmitter","components.dialogs","request","bundle!jasperserver_messages","text!dataSource/template/dialog/uploadJdbcDriverDialogTemplate.htm","text!dataSource/template/dialog/fileUploadTemplate.htm","utils.common"],function(e){"use strict";var t=e("dataSource/view/dialog/BaseDialog"),r=e("underscore"),a=e("jquery"),i=e("common/transport/AjaxFormSubmitter"),s=e("components.dialogs"),n=(e("request"),e("bundle!jasperserver_messages")),o=e("text!dataSource/template/dialog/uploadJdbcDriverDialogTemplate.htm"),l=e("text!dataSource/template/dialog/fileUploadTemplate.htm");return e("utils.common"),t.extend({TITLE:n["resource.dataSource.jdbc.selectDriverTitle"],PRIMARY_BUTTON_LABEL:n["button.upload"],SECONDARY_BUTTON_LABEL:n["button.cancel"],events:function(){return r.extend({},t.prototype.events,{"change input[type='file']":"onFileChange"})},initialize:function(e){this.driverClass=e.driverClass,this.driverAvailable=e.driverAvailable,this.fileIndex=0,t.prototype.initialize.apply(this,arguments)},onFileChange:function(e){var t=a(e.target),i=t.next(".message.warning");if(i.parent().removeClass("error"),t.val().match(/.jar$/)){if(t.is(this.$("input[type='file']:last-of-type"))){var s=0,o=this.$("input[type='file']");r.each(o,function(e,t){s+=t+1}),s>=o.length&&this.addFileInput(),this.$("button.primary").removeClass("disabled").attr("disabled",null)}}else i.text(n["resource.dataSource.jdbc.upload.wrongExtension"]).parent().addClass("error")},render:function(){var e=this;return this.$(".body").html(r.template(o,{className:this.driverClass,i18n:n})),r.defer(function(){e.addFileInput(),e.driverAvailable?e.$(".warningMessageContainer").removeClass("hidden").find(".message").text(n["resource.dataSource.jdbc.upload.overwriteWarning"]):e.$(".warningMessageContainer").addClass("hidden").find(".message").text("")}),this.$("button.primary").addClass("disabled").attr("disabled","disabled"),this},onSuccessCallback:function(e){this.trigger("driverUpload",e),this.hide(),s.systemConfirm.show(n["resource.dataSource.jdbc.upload.driverUploadSuccess"]),r.defer(r.bind(this.remove,this))},onErrorCallback:function(e){var t;e=e.responseJSON?e.responseJSON:e,t="illegal.parameter.value.error"===e.errorCode&&e.parameters&&e.parameters.length&&"className"===e.parameters[0]?n["resource.dataSource.jdbc.classNotFound"].replace("{0}",this.driverClass):e.message,this.$(".errorMessageContainer").addClass("error").find(".message").text(t)},addFileInput:function(){this.$("ul").append(r.template(l,{fileIndex:this.fileIndex})),this.fileIndex++},primaryButtonOnClick:function(){this.$(".errorMessageContainer").removeClass("error").find(".message").text("");var e=this.$("form"),t=this;new i(e[0]).submit().done(function(e){e.errorCode?t.onErrorCallback(e):t.onSuccessCallback(e)}).fail(function(e){t.onErrorCallback(e)})},secondaryButtonOnClick:function(){this.hide(),r.defer(r.bind(this.remove,this))}})});