define(["require","dataSource/view/dialog/BaseDialog","underscore","jquery","components.ajaxuploader","components.dialogs","common/transport/request","bundle!jasperserver_messages","text!dataSource/template/dialog/uploadJdbcDriverDialogTemplate.htm","text!dataSource/template/dialog/fileUploadTemplate.htm","utils.common"],function(e){var t=e("dataSource/view/dialog/BaseDialog"),a=e("underscore"),r=e("jquery"),s=e("components.ajaxuploader"),i=e("components.dialogs"),n=e("common/transport/request"),o=e("bundle!jasperserver_messages"),l=e("text!dataSource/template/dialog/uploadJdbcDriverDialogTemplate.htm"),d=e("text!dataSource/template/dialog/fileUploadTemplate.htm");return e("utils.common"),t.extend({TITLE:o["resource.dataSource.jdbc.selectDriverTitle"],PRIMARY_BUTTON_LABEL:o["button.upload"],SECONDARY_BUTTON_LABEL:o["button.cancel"],events:function(){return a.extend({},t.prototype.events,{"change input[type='file']":"onFileChange"})},initialize:function(e){this.driverClass=e.driverClass,this.driverAvailable=e.driverAvailable,this.fileIndex=0,t.prototype.initialize.apply(this,arguments)},onFileChange:function(e){var t=r(e.target),s=t.next(".message.warning");if(s.parent().removeClass("error"),t.val().match(/.jar$/)){if(t.is(this.$("input[type='file']:last-of-type"))){var i=0,n=this.$("input[type='file']");a.each(n,function(e,t){i+=t+1}),i>=n.length&&this.addFileInput()}}else s.text(o["resource.dataSource.jdbc.upload.wrongExtension"]).parent().addClass("error")},render:function(){var e=this;return this.$(".body").html(a.template(l,{className:this.driverClass,i18n:o})),a.defer(function(){e.addFileInput(),e.driverAvailable?e.$(".warningMessageContainer").removeClass("hidden").find(".message").text(o["resource.dataSource.jdbc.upload.overwriteWarning"]):e.$(".warningMessageContainer").addClass("hidden").find(".message").text("")}),this},onSuccessCallback:function(e){this.trigger("driverUpload",e),this.hide(),i.systemConfirm.show(o["resource.dataSource.jdbc.upload.driverUploadSuccess"]),a.defer(a.bind(this.remove,this))},onErrorCallback:function(e){var t,e=e.responseJSON?e.responseJSON:e;t="illegal.parameter.value.error"===e.errorCode&&e.parameters&&e.parameters.length&&"className"===e.parameters[0]?o["resource.dataSource.jdbc.classNotFound"].replace("{0}",this.driverClass):e.message,this.$(".errorMessageContainer").addClass("error").find(".message").text(t)},addFileInput:function(){this.$("ul").append(a.template(d,{fileIndex:this.fileIndex})),this.fileIndex++},primaryButtonOnClick:function(){this.$(".errorMessageContainer").removeClass("error").find(".message").text("");var e=this.$("form"),t=this;window.FormData?e.submit(function(r){var s=new FormData(e[0]),i=e.attr("method"),o=e.attr("action");n({url:o,type:i,data:s,cache:!1,contentType:!1,processData:!1,success:a.bind(t.onSuccessCallback,t),error:a.bind(t.onErrorCallback,t)}),r.preventDefault(),e.unbind("submit")}):new s(e[0],function(e){e.errorCode?t.onErrorCallback(e):t.onSuccessCallback(e)},12e5),e.submit()},secondaryButtonOnClick:function(){this.hide(),a.defer(a.bind(this.remove,this))}})});