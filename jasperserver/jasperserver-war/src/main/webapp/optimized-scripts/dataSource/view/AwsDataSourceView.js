define(["require","underscore","dataSource/view/JdbcDataSourceView","dataSource/view/BaseDataSourceView","dataSource/model/AwsDataSourceModel","dataSource/view/dialog/UploadJdbcDriverDialog","dynamicTree.utils","core.events.bis","bundle!jasperserver_messages","text!dataSource/template/awsSpecificTemplate.htm","settings!awsSettings","dataSource/util/settingsUtility"],function(e){var t=e("underscore"),a=e("dataSource/view/JdbcDataSourceView"),s=e("dataSource/view/BaseDataSourceView"),r=e("dataSource/model/AwsDataSourceModel"),i=e("dataSource/view/dialog/UploadJdbcDriverDialog"),o=e("dynamicTree.utils"),d=e("core.events.bis"),n=e("bundle!jasperserver_messages"),l=e("text!dataSource/template/awsSpecificTemplate.htm"),c=e("settings!awsSettings"),u=e("dataSource/util/settingsUtility");return a.extend({PAGE_TITLE_NEW_MESSAGE_CODE:"resource.datasource.aws.page.title.new",PAGE_TITLE_EDIT_MESSAGE_CODE:"resource.datasource.aws.page.title.edit",modelConstructor:r,events:function(){var e={};return t.extend(e,a.prototype.events),e["change input[name='credentialsType']"]="changeCredentialsType",e["click #findAwsDataSources"]="refreshAwsDataSourceTree",e},initialize:function(e){s.prototype.initialize.apply(this,arguments),this.deepDefaults=u.deepDefaults(e,{awsSettings:c}),this.listenTo(this.model,"change:credentialsType",this.onCredentialsTypeChange),this.listenTo(this.model,"change:driverClass",this.changeUploadDriverButtonState),this.listenTo(this.model,"change",this.updateInput),this.listenTo(this.model.drivers,"change add",this.recheckDriver)},changeCredentialsType:function(){var e=this.$("input[name='credentialsType']:checked").val();this.model.set("credentialsType",e)},recheckDriver:function(){this.model.validate({driverClass:this.model.get("driverClass")}),this.changeUploadDriverButtonState()},changeUploadDriverButtonState:function(){var e=this.$("#driverUploadButton");if(""===this.model.get("driverClass"))d.disable(e[0]);else{d.enable(e[0]);var t=this.model.drivers.getDriverByClass(this.model.get("driverClass"));e.find(".wrap").text(n[t&&t.get("available")?"resource.dataSource.jdbc.upload.editDriverButton":"resource.dataSource.jdbc.upload.addDriverButton"])}},initDriverUploadDialog:function(){var e=this,a=this.model.drivers.getDriverByClass(this.model.get("driverClass"));this.driverUploadDialog=new i({driverAvailable:!(!a||!a.get("available")),driverClass:this.model.get("driverClass")}),this.driverUploadDialog.on("driverUpload",function(a){e.model.drivers.markDriverAsAvailable(a.jdbcDriverClass),t.defer(t.bind(e.model.validate,e.model))})},updateInput:function(){var e=t.keys(this.model.changedAttributes()),a=["accessKey","secretKey","roleArn","connectionUrl","driverClass","dbName"],s=this;t.each(t.intersection(e,a),function(e){s.$("[name='"+e+"']").val(s.model.get(e))})},onCredentialsTypeChange:function(){var e=this.model.get("credentialsType")===r.credentialsType.EC2;this.$("#aws_settings")[e?"hide":"show"](),e&&this.showAwsDsTree(this.model.getFullDbTreePath())},refreshAwsDataSourceTree:function(e){e.preventDefault(),this.showAwsDsTree("/")},render:function(){return this.$el.empty(),this.renderTimezoneSection(),this.renderAwsSpecificSection(),this.renderTestConnectionSection(),this.initDataSourceTree(),(this.options.isEditMode||this.model.get("credentialsType")===r.credentialsType.EC2)&&this.showAwsDsTree(this.model.getFullDbTreePath()),this},showAwsDsTree:function(e){this.model.validate({accessKey:this.model.get("accessKey"),secretKey:this.model.get("secretKey")}),this.model.isValid("secretKey")&&this.model.isValid("accessKey")&&this.awsDataSourceTree.showTreePrefetchNodes(e||"/")},templateData:function(){var e=a.prototype.templateData.apply(this,arguments);return t.extend(e,{credentialsType:r.credentialsType,awsRegions:this.deepDefaults.awsSettings.awsRegions,disableAwsDefaults:!this.deepDefaults.awsSettings.isEc2Instance||this.deepDefaults.awsSettings.suppressEc2CredentialsWarnings}),e},renderAwsSpecificSection:function(){this.$el.append(t.template(l,this.templateData())),this.changeUploadDriverButtonState()},initDataSourceTree:function(){var e=this.options.isEditMode,t=this,a={hideLoader:!0,bShowRoot:!1,treeId:"awsDataSourceTree",providerId:"awsDataSourceTreeDataProvider",selectLeavesOnly:!0,additionalParams:function(){return{arn:t.model.get("roleArn"),awsAccessKey:t.model.get("accessKey"),awsSecretKey:t.model.get("secretKey"),region:t.model.get("region"),datasourceUri:t.model.get("uri")}}};this.awsDataSourceTree=o.createRepositoryTree("awsDataSourceTree",a),this.awsDataSourceTree.observe("leaf:selected",function(a){var s=a.memo.node.param;if("awsDb"===s.type&&!e){var r=s.extra,i=r.dbUri.split("/");t.model.set({connectionUrlTemplate:r.jdbcTemplate,driverClass:r.jdbcDriverClass,dbName:r.dBName,dbHost:r.dnsAddress,dbPort:r.dbPort,sName:r.dBName,dbService:i[1],dbInstanceIdentifier:i[2]}),t.model.validate({driverClass:t.model.get("driverClass")})}}),this.awsDataSourceTree.observe("tree:loaded",function(){t.model.getFullDbTreePath()&&t.awsDataSourceTree.openAndSelectNode(t.model.getFullDbTreePath(),function(){e=!1;var a=t.awsDataSourceTree.getSelectedNode();a&&a.param&&a.param.extra&&t.model.set({connectionUrlTemplate:a.param.extra.jdbcTemplate,dbHost:a.param.extra.dnsAddress,dbPort:a.param.extra.dbPort})})})},remove:function(){this.awsDataSourceTree&&this.awsDataSourceTree.stopObserving(),a.prototype.remove.apply(this,arguments)}})});