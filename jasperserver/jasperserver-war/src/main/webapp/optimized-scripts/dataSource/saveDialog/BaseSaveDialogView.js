define(["require","underscore","bundle!all","common/model/RepositoryResourceModel","common/component/dialog/DialogWithModelInputValidation","common/component/tree/treeFactory","jrs.configs","text!dataSource/saveDialog/template/baseSaveDialogTemplate.htm"],function(e){var o=e("underscore"),t=e("bundle!all"),i=e("common/model/RepositoryResourceModel"),a=e("common/component/dialog/DialogWithModelInputValidation"),r=(e("common/component/tree/treeFactory"),e("jrs.configs")),n=e("text!dataSource/saveDialog/template/baseSaveDialogTemplate.htm");return a.extend({theDialogIsOpen:!1,autoUpdateResourceID:!0,saveDialogTemplate:n,constructor:function(e){e||(e={}),this.options=e;var i=this.extendModel(this.options.model),r=this._getLabelForSaveButton(i),n="resource.datasource.saveDialog.cancel";this.autoUpdateResourceID=!this.options.isEditMode,this.preSelectedFolder=e.parentFolderUri,a.prototype.constructor.call(this,{skipLocation:!!e.skipLocation,modal:!0,model:i,resizable:!0,additionalCssClasses:"dataSourceSaveDialog",title:t["resource.datasource.saveDialog.save"],content:o.template(this.saveDialogTemplate,{i18n:t,model:o.extend({},i.attributes),skipLocation:!!this.options.skipLocation,isEmbedded:this.options.isEmbedded,isEditMode:this.options.isEditMode}),buttons:[{label:t[r],action:"save",primary:!0},{label:t[n],action:"cancel",primary:!1}]}),this.on("button:save",o.bind(this._onSaveDialogSaveButtonClick,this)),this.on("button:cancel",o.bind(this._onSaveDialogCancelButtonClick,this))},initialize:function(e){a.prototype.initialize.apply(this,arguments),(o.isUndefined(this.preSelectedFolder)||!this.preSelectedFolder)&&(this.preSelectedFolder="/"),e.skipLocation||this.initializeTree(),this.listenTo(this.model,"change:label",this._onDataSourceNameChange),this.$contentContainer.find("[name=name]").change(o.bind(this._onResourceIDInputChange,this))},restoreModel:function(){this.originalModelValidation&&(this.model.validation=this.originalModelValidation)},extendModel:function(e){return this.originalModelValidation=e.validation,e.validation=o.extend({},i.prototype.validation,{label:[{required:!0,msg:t["resource.datasource.saveDialog.validation.not.empty.label"]},{maxLength:i.LABEL_MAX_LENGTH,msg:t["resource.datasource.saveDialog.validation.too.long.label"]}],name:[{required:!0,msg:t["resource.datasource.saveDialog.validation.not.empty.name"]},{maxLength:i.NAME_MAX_LENGTH,msg:t["resource.datasource.saveDialog.validation.too.long.name"]},{doesNotContainSymbols:i.NAME_NOT_SUPPORTED_SYMBOLS,msg:t["resource.datasource.saveDialog.validation.invalid.chars.name"]}],description:[{required:!1},{maxLength:i.DESCRIPTION_MAX_LENGTH,msg:t["resource.datasource.saveDialog.validation.too.long.description"]}],parentFolderUri:[{fn:function(e){if(!this.options.skipLocation){if(o.isNull(e)||o.isUndefined(e)||o.isString(e)&&""===e)return t["resource.datasource.saveDialog.validation.not.empty.parentFolderIsEmpty"];if("/"!==e.slice(0,1))return t["resource.datasource.saveDialog.validation.folder.not.found"].replace("{0}",e)}}}]}),e},initializeTree:function(){var e=this,t=o.uniqueId("baseSaveDialogTree");this.$contentContainer.find(".control.groupBox .folders").attr("id",t);var i=this.getSaveAsTree(t);i.observe("node:selected",function(o){e.model.set("parentFolderUri",o.memo.node.param.uri)}),i.showTreePrefetchNodes(this.preSelectedFolder,function(){i.openAndSelectNode(e.preSelectedFolder)})},getSaveAsTree:function(e){var o,t=this.options,i="repositoryExplorerTreeFoldersProvider",a="treeFlow";r.isProVersion&&(i="adhocRepositoryTreeFoldersProvider",a="adhocTreeFlow"),o=dynamicTree.createRepositoryTree(e,{providerId:i,organizationId:t.organizationName?t.organizationName:r.organizationName?r.organizationName:"Organization",rootUri:"/",urlGetNode:"flow.html?_flowId="+a+"&method=getNode",urlGetChildren:"flow.html?_flowId="+a+"&method=getChildren",treeErrorHandlerFn:function(){}});var n=o.modifyRootObject,s=o.modifyRootObject=function(e,o,t,i){for(var a=o?e:e.children,r=0,l=a.length;l>r;r++)a[r].extra.isWritable||(a[r].cssClass="readonly"),a[r].children&&s(a[r],!1,a[r],!0);return o?e=a:e.children=a,i?void 0:n.call(this,e,o,t)};return o},startSaveDialog:function(){this._openDialog()},_openDialog:function(){this.theDialogIsOpen||(this.bindValidation(),a.prototype.open.apply(this,arguments),this.$contentContainer.find("[name=label]").focus(),this.theDialogIsOpen=!0)},_closeDialog:function(){this.theDialogIsOpen&&(this.unbindValidation(),this.clearValidationErrors(),a.prototype.close.apply(this,arguments),this.theDialogIsOpen=!1)},_getLabelForSaveButton:function(){return"resource.datasource.saveDialog.save"},_onDataSourceNameChange:function(){if(this.autoUpdateResourceID){var e=i.generateResourceName(this.model.get("label"));this.model.set("name",e),this.$("input[name='name']").val(e)}},_onResourceIDInputChange:function(){this.autoUpdateResourceID=!1},_onSaveDialogCancelButtonClick:function(){this.restoreModel(),this._closeDialog()},_onSaveDialogSaveButtonClick:function(){this.model.isValid(!0)&&this.performSave()},performSave:function(){return this.options.saveFn?void this.options.saveFn(this.model.attributes,this.model):void this.model.save({},{success:o.bind(this._saveSuccessCallback,this),error:o.bind(this._saveErrorCallback,this)})},_saveSuccessCallback:function(){this._closeDialog(),o.isFunction(this.options.success)&&this.options.success()},_saveErrorCallback:function(e,i,a){var r,n=!1;try{n=JSON.parse(i.responseText)}catch(s){}if(this.theDialogIsOpen){var l=this;if("version.not.match"===n.errorCode)return void this.fieldIsInvalid(l,"name",t["resource.dataSource.resource.exists"],"name");if("mandatory.parameter.error"===n.errorCode){if(n.parameters&&n.parameters[0]){var d=n.parameters[0].substr(n.parameters[0].indexOf(".")+1);return void this.fieldIsInvalid(l,d,t["resource.datasource.saveDialog.parameterIsMissing"],"name")}}else{if("folder.not.found"===n.errorCode)return void this.fieldIsInvalid(l,"parentFolderUri",t["ReportDataSourceValidator.error.folder.not.found"].replace("{0}",n.parameters[0]),"name");if("access.denied"===n.errorCode)return void this.fieldIsInvalid(l,"parentFolderUri",t["jsp.accessDenied.errorMsg"],"name")}}r="Failed to save data source.",n[0]&&n[0].errorCode?r+="<br/>The reason is: "+n[0].errorCode:n.message&&(r+="<br/>The reason is: "+n.message),r+="<br/><br/>The full response from the server is: "+i.responseText,dialogs.errorPopup.show(r),o.isFunction(this.options.error)&&this.options.error(e,i,a)}})});