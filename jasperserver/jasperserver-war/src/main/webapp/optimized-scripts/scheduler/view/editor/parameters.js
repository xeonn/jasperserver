define(["require","controls.options","controls.controller","jquery","underscore","jrs.configs","backbone","text!scheduler/template/parameters.htm","bundle!jasperserver_messages"],function(e){e("controls.options"),e("controls.controller");var o=e("jquery"),r=e("underscore"),t=e("jrs.configs"),n=e("backbone"),i=e("text!scheduler/template/parameters.htm");return r.extend(ControlsBase,t.inputControlsConstants),n.View.extend({el:"#scheduler_editor div.tab[data-tab=parameters]",initialize:function(){var n=this;if(t.isProVersion){var s=e("bundle!jasperserver_messages"),p=r.template(i);n.header=o(p({i18n:s,config:t})),n.$el.parent().find(".schedule_for").append(n.header),n.reportOptions=new JRS.Controls.ReportOptions,n.reportOptionsDialog=new OptionsDialog({"button#saveAsBtnSave":function(){var e=n.reportOptionsDialog.input.getValue(),r=n.controlsController.getViewModel().get("selection"),t=e===n.reportOptionsDialog.optionNameToOverwrite;o.when(n.reportOptions.add(n.reportOptions.optionsUrl||n.reportOptions.url,e,r,t)).done(function(){n.reportOptionsDialog.hideWarning();var e=n.reportOptions.getElem().parent();0==e.length&&(e=o(".sub.header"),e.prepend(n.reportOptions.getElem())),n.reportOptionsDialog.hide(),delete n.reportOptionsDialog.optionNameToOverwrite}).fail(function(r){try{var i=o.parseJSON(r.responseText);"report.options.dialog.confirm.message"===i.errorCode&&!t&&(n.reportOptionsDialog.optionNameToOverwrite=e),n.reportOptionsDialog.showWarning(i.message)}catch(s){}})},"button#saveAsBtnCancel":function(){n.reportOptionsDialog.hide()}}),n.header.find("button#save").click(function(){n.reportOptionsDialog.show()})}n.model.on("save",function(e,o){if(n.model.get("source").parameters){var r=o();n.controlsController.validate().then(function(e){r(!e),e||n.model.trigger("invalid",n,[{field:"parametersErrorNotifierStub",errorCode:"report.scheduling.list.state.5"}],{switchToErrors:!0})})}}),n.model.on("change:source",function(e,o){var r=o&&o.reportUnitURI,t=n.model.get("source").parameters;if(t){t=t.parameterValues;for(var i in t)t.hasOwnProperty(i)&&null===t[i]&&delete t[i];n.reportOptions&&(n.reportOptions.url=void 0),n.controlsController&&r===n.controlsController.reportUri||(n.controlsController=new JRS.Controls.Controller({reportUri:r,reportOptionUri:"",preSelectedData:t})),n.controlsController.fetchControlsStructure(t)}}),n.model.on("change:source",function(e,r){var t=r&&r.reportUnitURI;n.reportOptions&&t!==n.reportOptions.url&&(n.reportOptions.optionsUrl=void 0,n.model.resource("reportOptions",function(e,r){e||(n.reportOptions.optionsUrl=r.reportUri,o.when(n.reportOptions.fetch(r.reportUri||t,"")).done(function(){n.header.prepend(n.reportOptions.getElem()),o(document).trigger("viewmodel:selection:changed")}))}),n.model.permission(function(e,o){var r=!!e||!(1===o||30===o);n.header.find("button#save").attr("disabled",r)}),n.reportOptions.url=t)}),o(document).on("viewmodel:values:changed",function(){n.model.set("source",{reportUnitURI:n.model.get("source").reportUnitURI,parameters:{parameterValues:n.controlsController.getViewModel().get("selection")}},{validate:!1,silent:!0})}),n.reportOptions&&o(document).on("viewmodel:selection:changed",function(){var e=n.reportOptions.find({uri:n.reportOptions.url});n.reportOptions.set({selection:e},!0)})}})});