define(["require","controls.options","controls.controller","jquery","underscore","jrs.configs","backbone","text!scheduler/template/parameters.htm","bundle!jasperserver_messages"],function(e){"use strict";e("controls.options"),e("controls.controller");var o=e("jquery"),r=e("underscore"),t=e("jrs.configs"),n=e("backbone"),i=e("text!scheduler/template/parameters.htm");return r.extend(ControlsBase,t.inputControlsConstants),n.View.extend({el:"#scheduler_editor div.tab[data-tab=parameters]",initialize:function(n){var s=this;if(this.options=n,t.isProVersion){var l=e("bundle!jasperserver_messages"),p=r.template(i);s.header=o(p({i18n:l,config:t})),s.$el.parent().find(".schedule_for").append(s.header),s.reportOptions=new JRS.Controls.ReportOptions,s.reportOptionsDialog=new OptionsDialog({"button#saveAsBtnSave":function(){var e=s.reportOptionsDialog.input.getValue(),r=s.controlsController.getViewModel().get("selection"),t=e===s.reportOptionsDialog.optionNameToOverwrite;o.when(s.reportOptions.add(s.reportOptions.optionsUrl||s.reportOptions.url,e,r,t)).done(function(){s.reportOptionsDialog.hideWarning();var e=s.reportOptions.getElem().parent();0===e.length&&(e=o(".sub.header"),e.prepend(s.reportOptions.getElem())),s.reportOptionsDialog.hide(),delete s.reportOptionsDialog.optionNameToOverwrite}).fail(function(r){try{var n=o.parseJSON(r.responseText);"report.options.dialog.confirm.message"===n.errorCode&&!t&&(s.reportOptionsDialog.optionNameToOverwrite=e),s.reportOptionsDialog.showWarning(n.message)}catch(i){}})},"button#saveAsBtnCancel":function(){s.reportOptionsDialog.hide()}}),s.header.find("button#save").click(function(){s.reportOptionsDialog.show()})}s.model.on("save",function(e,o){if(s.model.get("source").parameters){var r=o();s.controlsController.validate().then(function(e){r(!e),e||s.model.trigger("invalid",s,[{field:"parametersErrorNotifierStub",errorCode:"report.scheduling.list.state.5"}],{switchToErrors:!0})})}}),s.model.on("change:source",function(e,o){var r=o&&o.reportUnitURI,t=s.model.get("source").parameters;if(t){t=t.parameterValues;for(var n in t)t.hasOwnProperty(n)&&null===t[n]&&delete t[n];s.reportOptions&&(s.reportOptions.url=void 0),s.controlsController&&r===s.controlsController.reportUri||(s.controlsController=new JRS.Controls.Controller({reportUri:r,reportOptionUri:"",preSelectedData:t})),s.controlsController.fetchControlsStructure(t).done(function(){s.trigger("ICLoaded")}).fail(function(){s.trigger("failedToLoadIC")})}}),s.model.on("change:source",function(e,r){var t=r&&r.reportUnitURI;s.reportOptions&&t!==s.reportOptions.url&&(s.reportOptions.optionsUrl=void 0,s.model.resource("reportOptions",function(e,r){e||(s.reportOptions.optionsUrl=r.reportUri,o.when(s.reportOptions.fetch(r.reportUri||t,"")).done(function(){s.header.prepend(s.reportOptions.getElem()),o(document).trigger("viewmodel:selection:changed")}))}),s.model.permission(function(e,o){var r=!!e||!(1===o||30===o);s.header.find("button#save").attr("disabled",r)}),s.reportOptions.url=t)}),o(document).on("viewmodel:values:changed",function(){s.model.set("source",{reportUnitURI:s.model.get("source").reportUnitURI,parameters:{parameterValues:s.controlsController.getViewModel().get("selection")}},{validate:!1,silent:!0})}),s.reportOptions&&o(document).on("viewmodel:selection:changed",function(){var e=s.reportOptions.find({uri:s.reportOptions.url});s.reportOptions.set({selection:e},!0)})}})});