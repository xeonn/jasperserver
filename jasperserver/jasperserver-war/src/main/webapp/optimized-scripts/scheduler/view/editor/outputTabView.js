define(["require","jquery","underscore","bundle!all","jrs.configs","backbone","components.pickers","resource.base","text!scheduler/template/editor/outputTabTemplate.htm","bi/repo/dialog/RepositoryChooserDialog/RepositoryChooserDialogFactory"],function(t){"use strict";var e=t("jquery"),o=t("underscore"),r=t("bundle!all"),n=t("jrs.configs"),i=t("backbone"),s=(t("components.pickers"),t("resource.base"),t("text!scheduler/template/editor/outputTabTemplate.htm")),a=t("bi/repo/dialog/RepositoryChooserDialog/RepositoryChooserDialogFactory");return i.View.extend({events:{"click .ftp-test":"testFTPConnection","click [name=outputRepositoryButton]":"outputRepositoryButtonClick"},initialize:function(){var t=this;this.model.on("change:repositoryDestination",function(e,o){var r=e.get("repositoryDestination");t.$el.find("[name=ftpPort]").val(r.outputFTPInfo.port),t.$el.find("[name=useFTPS]").prop("checked","TYPE_FTPS"===r.outputFTPInfo.type)})},getFolderChooserDialog:function(){if(this.folderChooserDialog)return this.folderChooserDialog;var t=this,e=a.getDialog("folder");return this.folderChooserDialog=new e,this.listenTo(this.folderChooserDialog,"close",function(){var e;this.folderChooserDialog.selectedResource&&this.folderChooserDialog.selectedResource.resourceUri&&(e=this.folderChooserDialog.selectedResource.resourceUri,t.$el.find("[name=outputRepository]").val(e).trigger("change"))}),this.folderChooserDialog},outputRepositoryButtonClick:function(){var t=this.getFolderChooserDialog();t.open();var e=t.foldersTree.$el.parent();t.foldersTree._selectTreeNode(this.model.get("repositoryDestination").folderURI,e)},render:function(){var t=o.extend({},{_:o,i18n:r,timeZones:n.timeZones},this.model.attributes);this.setElement(e(o.template(s,t)));var i=this;this.$el.find("[name=outputToHostFileSystem]").attr("disabled","true"===n.enableSaveToHostFS||n.enableSaveToHostFS===!0?!1:"disabled"),this.map=[{attr:"baseOutputFilename",control:"baseOutputFilename"},{attr:"repositoryDestination/outputDescription",control:"outputDescription"},{attr:"outputTimeZone",control:"timeZone"},{attr:"outputLocale",control:"outputLocale"},{attr:"outputFormats/outputFormat",control:"outputFormats"},{attr:"repositoryDestination/overwriteFiles",control:"overwriteFiles"},{attr:"repositoryDestination/sequentialFilenames",control:"sequentialFilenames"},{attr:"repositoryDestination/timestampPattern",control:"timestampPattern"},{attr:"repositoryDestination",control:"timestampPattern",depends:"repositoryDestination/sequentialFilenames"},{attr:"repositoryDestination/saveToRepository",control:"outputToRepository"},{attr:"repositoryDestination",control:"outputRepository, outputRepositoryButton",depends:"repositoryDestination/saveToRepository"},{attr:"repositoryDestination/folderURI",control:"outputRepository"},{attr:"repositoryDestination",control:"outputHostFileSystem",depends:"repositoryDestination/outputLocalFolder",disabled:!("true"===n.enableSaveToHostFS||n.enableSaveToHostFS===!0)},{attr:"repositoryDestination/outputLocalFolder",control:"outputToHostFileSystem",getter:function(t){return!1===t?null:""},setter:function(t){return""===t||!!t}},{attr:"repositoryDestination/outputLocalFolder",control:"outputHostFileSystem"},{attr:"repositoryDestination/outputFTPInfo/enabled",control:"outputToFTPServer",getter:function(t){return t===!1&&i.$el.find("#ftpServerOutput").find(".error").removeClass("error"),t}},{attr:"repositoryDestination/outputFTPInfo",control:"ftpAddress, ftpDirectory, ftpUsername, ftpPassword, ftpTestButton, ftpPort, useFTPS",depends:"repositoryDestination/outputFTPInfo/enabled"},{attr:"repositoryDestination/outputFTPInfo/serverName",control:"ftpAddress"},{attr:"repositoryDestination/outputFTPInfo/folderPath",control:"ftpDirectory"},{attr:"repositoryDestination/outputFTPInfo/userName",control:"ftpUsername",setter:function(t){return"anonymous"==t?null:t}},{attr:"repositoryDestination/outputFTPInfo/password",control:"ftpPassword"},{attr:"repositoryDestination/outputFTPInfo/port",control:"ftpPort"}],o.each(this.map,function(t){if(t.control=t.control.split(","),t.control=t.control.map(function(t){return"[name="+t+"]"}),t.control=i.$el.find(t.control.join(",")),t.attr&&(t.attr=t.attr.split("/")),t.depends&&"!"===t.depends[0]&&(t.invert=!0,t.depends=t.depends.substr(1)),t.depends&&!t.attr){t.depends=i.$el.find("[name="+t.depends+"]");var r=function(){var e=t.setter?t.setter(t.depends):t.depends.val();t.control.attr("disabled",t.disabled?"disabled":t.invert?!!e:!e)};return t.depends.on("change",r),r()}i.model.on("change:"+t.attr[0],function(e,o){if(o=e.value(t.attr.join("/")),t.setter&&(o=t.setter(o)),t.depends){var r=e.value(t.depends);return t.setter?r=t.setter(r):""===r&&(r=!0),t.control.attr("disabled",t.disabled?"disabled":t.invert?!!r:!r)}t.control.is("[type=checkbox]")&&1===t.control.length?t.control.prop("checked",o):t.control.is("[type=radio]")?t.control.filter("[value="+o+"]").prop("checked",!0):t.control.val(o)}),t.control.length&&!t.depends&&t.control.on("change",function(){var r,n,s,a;if(n=t.control.is("[type=checkbox]")?t.control.filter(":checked").map(function(){return e(this).val()}).get():t.control.val(),t.control.is("[type=checkbox]")&&1===t.control.length&&(n=!!n[0]),t.control.is("[type=radio]")&&(n=t.control.filter(":checked").val()),t.getter&&(n=t.getter(n,o.clone(i.model.value(t.attr.join("/"))))),t.attr.length>1){a=s=o.clone(i.model.get(t.attr[0]));for(var l=1,u=t.attr.length-1;u>l;l++)r=t.attr[l],a[r]=a[r]?o.clone(a[r]):{},a=a[r];a[t.attr[t.attr.length-1]]=n}i.model.update(t.attr[0],s||n)})}),this.$el.find("[name=useFTPS]").on("click",function(){var t="TYPE_FTP",o="21";e(this).is(":checked")&&(t="TYPE_FTPS",o="990");var r=e.extend(!0,{},i.model.get("repositoryDestination"));r=r||{},r.outputFTPInfo=r.outputFTPInfo||{},r.outputFTPInfo.type=t,r.outputFTPInfo.port=o,i.model.update("repositoryDestination",r)})},testFTPConnection:function(){e("#ftpTestButton").addClass("disabled"),this.model.testFTPConnection(function(){e("#ftpTestButton").removeClass("disabled")})}})});