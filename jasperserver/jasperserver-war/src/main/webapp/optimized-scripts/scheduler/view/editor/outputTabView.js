define(["require","jquery","underscore","bundle!all","jrs.configs","backbone","components.pickers","resource.base","text!scheduler/template/editor/outputTabTemplate.htm","bi/repo/dialog/RepositoryChooserDialog/RepositoryChooserDialogFactory"],function(t){"use strict";function e(t,o,r){var n,i=this,s=t.split("/");r=r||0;var a=s[r]?t.match(new RegExp(".*\\/"+s[r]))[0]:"/";return n=this.getLevel(a),r===s.length?o.resolve(s):void(n&&(n.collapsed?(n.once("ready",function(){e.call(i,t,o,r+1)}),n.open()):e.call(this,t,o,r+1)))}var o=t("jquery"),r=t("underscore"),n=t("bundle!all"),i=t("jrs.configs"),s=t("backbone"),a=(t("components.pickers"),t("resource.base"),t("text!scheduler/template/editor/outputTabTemplate.htm")),l=t("bi/repo/dialog/RepositoryChooserDialog/RepositoryChooserDialogFactory");return s.View.extend({events:{"click .ftp-test":"testFTPConnection","click [name=outputRepositoryButton]":"outputRepositoryButtonClick"},initialize:function(){var t=this;this.model.on("change:repositoryDestination",function(e,o){var r=e.get("repositoryDestination");t.$el.find("[name=ftpPort]").val(r.outputFTPInfo.port),t.$el.find("[name=useFTPS]").prop("checked","TYPE_FTPS"===r.outputFTPInfo.type)})},getFolderChooserDialog:function(){if(this.folderChooserDialog)return this.folderChooserDialog;var t=this,e=l.getDialog("folder");return this.folderChooserDialog=new e,this.listenTo(this.folderChooserDialog,"close",function(){var e;this.folderChooserDialog.selectedResource&&this.folderChooserDialog.selectedResource.resourceUri&&(e=this.folderChooserDialog.selectedResource.resourceUri,t.$el.find("[name=outputRepository]").val(e).trigger("change"))}),this.folderChooserDialog},outputRepositoryButtonClick:function(){var t=new o.Deferred,r=this.model.get("repositoryDestination").folderURI,n=r.split("/"),i=this.getFolderChooserDialog(),s=i.foldersTree,a=n.splice(0,n.length-1).join("/");i.open(),s.rootLevel.on("ready",function(){t.done(function(){s.select(r);var t=s.$el,e=t.parent(),o=s.getLevel(r).$el,n=o.offset().top-t.offset().top-e.height()/2;e.scrollTop(n)}),e.call(s,a,t)})},render:function(){var t=r.extend({},{_:r,i18n:n,timeZones:i.timeZones},this.model.attributes);this.setElement(o(r.template(a,t)));var e=this;this.$el.find("[name=outputToHostFileSystem]").attr("disabled","true"===i.enableSaveToHostFS||i.enableSaveToHostFS===!0?!1:"disabled"),this.map=[{attr:"baseOutputFilename",control:"baseOutputFilename"},{attr:"repositoryDestination/outputDescription",control:"outputDescription"},{attr:"outputTimeZone",control:"timeZone"},{attr:"outputLocale",control:"outputLocale"},{attr:"outputFormats/outputFormat",control:"outputFormats"},{attr:"repositoryDestination/overwriteFiles",control:"overwriteFiles"},{attr:"repositoryDestination/sequentialFilenames",control:"sequentialFilenames"},{attr:"repositoryDestination/timestampPattern",control:"timestampPattern"},{attr:"repositoryDestination",control:"timestampPattern",depends:"repositoryDestination/sequentialFilenames"},{attr:"repositoryDestination/saveToRepository",control:"outputToRepository"},{attr:"repositoryDestination",control:"outputRepository, outputRepositoryButton",depends:"repositoryDestination/saveToRepository"},{attr:"repositoryDestination/folderURI",control:"outputRepository"},{attr:"repositoryDestination",control:"outputHostFileSystem",depends:"repositoryDestination/outputLocalFolder",disabled:!("true"===i.enableSaveToHostFS||i.enableSaveToHostFS===!0)},{attr:"repositoryDestination/outputLocalFolder",control:"outputToHostFileSystem",getter:function(t){return!1===t?null:""},setter:function(t){return""===t||!!t}},{attr:"repositoryDestination/outputLocalFolder",control:"outputHostFileSystem"},{attr:"repositoryDestination/outputFTPInfo/enabled",control:"outputToFTPServer",getter:function(t){return t===!1&&e.$el.find("#ftpServerOutput").find(".error").removeClass("error"),t}},{attr:"repositoryDestination/outputFTPInfo",control:"ftpAddress, ftpDirectory, ftpUsername, ftpPassword, ftpTestButton, ftpPort, useFTPS",depends:"repositoryDestination/outputFTPInfo/enabled"},{attr:"repositoryDestination/outputFTPInfo/serverName",control:"ftpAddress"},{attr:"repositoryDestination/outputFTPInfo/folderPath",control:"ftpDirectory"},{attr:"repositoryDestination/outputFTPInfo/userName",control:"ftpUsername",setter:function(t){return"anonymous"==t?null:t}},{attr:"repositoryDestination/outputFTPInfo/password",control:"ftpPassword"},{attr:"repositoryDestination/outputFTPInfo/port",control:"ftpPort"}],r.each(this.map,function(t){if(t.control=t.control.split(","),t.control=t.control.map(function(t){return"[name="+t+"]"}),t.control=e.$el.find(t.control.join(",")),t.attr&&(t.attr=t.attr.split("/")),t.depends&&"!"===t.depends[0]&&(t.invert=!0,t.depends=t.depends.substr(1)),t.depends&&!t.attr){t.depends=e.$el.find("[name="+t.depends+"]");var n=function(){var e=t.setter?t.setter(t.depends):t.depends.val();t.control.attr("disabled",t.disabled?"disabled":t.invert?!!e:!e)};return t.depends.on("change",n),n()}e.model.on("change:"+t.attr[0],function(e,o){if(o=e.value(t.attr.join("/")),t.setter&&(o=t.setter(o)),t.depends){var r=e.value(t.depends);return t.setter?r=t.setter(r):""===r&&(r=!0),t.control.attr("disabled",t.disabled?"disabled":t.invert?!!r:!r)}t.control.is("[type=checkbox]")&&1===t.control.length?t.control.prop("checked",o):t.control.is("[type=radio]")?t.control.filter("[value="+o+"]").prop("checked",!0):t.control.val(o)}),t.control.length&&!t.depends&&t.control.on("change",function(){var n,i,s,a;if(i=t.control.is("[type=checkbox]")?t.control.filter(":checked").map(function(){return o(this).val()}).get():t.control.val(),t.control.is("[type=checkbox]")&&1===t.control.length&&(i=!!i[0]),t.control.is("[type=radio]")&&(i=t.control.filter(":checked").val()),t.getter&&(i=t.getter(i,r.clone(e.model.value(t.attr.join("/"))))),t.attr.length>1){a=s=r.clone(e.model.get(t.attr[0]));for(var l=1,p=t.attr.length-1;p>l;l++)n=t.attr[l],a[n]=a[n]?r.clone(a[n]):{},a=a[n];a[t.attr[t.attr.length-1]]=i}e.model.update(t.attr[0],s||i)})}),this.$el.find("[name=useFTPS]").on("click",function(){var t="TYPE_FTP",r="21";o(this).is(":checked")&&(t="TYPE_FTPS",r="990");var n=o.extend(!0,{},e.model.get("repositoryDestination"));n=n||{},n.outputFTPInfo=n.outputFTPInfo||{},n.outputFTPInfo.type=t,n.outputFTPInfo.port=r,e.model.update("repositoryDestination",n)})},testFTPConnection:function(){o("#ftpTestButton").addClass("disabled"),this.model.testFTPConnection(function(){o("#ftpTestButton").removeClass("disabled")})}})});