define(["require","jquery","underscore","backbone","scheduler/model/jobModel","bundle!all","common/component/dialog/AlertDialog","scheduler/saveDialog/SaveDialogView","scheduler/view/editor/scheduleTabView","scheduler/view/editor/parametersTabView","scheduler/view/editor/outputTabView","scheduler/view/editor/notificationsTabView","scheduler/util/schedulerUtils","text!scheduler/template/jobEditorViewTemplate.htm"],function(e){"use strict";var t=e("jquery"),i=e("underscore"),r=e("backbone"),a=e("scheduler/model/jobModel"),s=e("bundle!all"),o=e("common/component/dialog/AlertDialog"),n=e("scheduler/saveDialog/SaveDialogView"),l=e("scheduler/view/editor/scheduleTabView"),d=e("scheduler/view/editor/parametersTabView"),h=e("scheduler/view/editor/outputTabView"),c=e("scheduler/view/editor/notificationsTabView"),u=(e("scheduler/util/schedulerUtils"),e("text!scheduler/template/jobEditorViewTemplate.htm"));return r.View.extend({editMode:!1,runNowMode:!1,events:{"mouseup [name=tabs] li":"tabChangeClickEvent","touchend [name=tabs] li":"tabChangeClickEvent","click [name=openSaveDialog]":"openSaveDialogClick","click [name=cancelJobCreation]":"cancelJobCreationClick"},initialize:function(e){this.options=i.extend({},e),this.model=new a,this.listenTo(this.model,"valid",this.validModelListener),this.listenTo(this.model,"invalid",this.invalidModelListener),this.listenTo(this.model,"clearAllErrors",this.clearAllValidationErrors),this.listenTo(this.model,"change:source",this.sourceKeyInModelChanged),this.listenTo(this.model,"failedToGet_IC",this.InputControlsNotLoaded),this.tabs={};var t={model:this.model,reportUri:this.options.reportUri,parentReportURI:this.options.parentReportURI};this.tabs.scheduleTab=new l(t),this.tabs.parametersTab=new d(t),this.tabs.outputTab=new h(t),this.tabs.notificationsTab=new c(t),this.listenTo(this.tabs.parametersTab,"IC_Displayed",this.InputControlsLoaded),this.listenTo(this.tabs.parametersTab,"failedToGet_IC",this.InputControlsNotLoaded)},remove:function(){this.tabs.scheduleTab.remove(),this.tabs.parametersTab.remove(),this.tabs.outputTab.remove(),this.tabs.notificationsTab.remove(),r.View.prototype.remove.apply(this,arguments)},tabChangeClickEvent:function(e){var i=t(e.currentTarget);if(!i.hasClass("disabled")){this.model.isValid();var r=this.$el.find("[name=tabHolder]").find(".error");if(r.length)return void this.changeActiveTab("error");var a=i.attr("data-tab");this.changeActiveTab(a)}},openSaveDialogClick:function(){this.startSavingProcess()},cancelJobCreationClick:function(){this.trigger("cancelJobCreation")},renderCreateNewJobInterface:function(){this.editMode=!1,this._render(),this.options.runInBackgroundMode||this.runNowMode?this.changeActiveTab("outputTab"):this.changeActiveTab("scheduleTab"),this.prepareSaveOrSubmitButton()},prepareModelForCreatingNewJob:function(){this.model.clear({silent:!0}),delete this.model.id,this.dontReactOnModelChange=!0,this.model.createFromUri(this.options.reportUri),this.dontReactOnModelChange=!1,this.runNowMode&&this.model.set("label","Immediate Execution"),this.model.loadParameters(this.options.parentReportURI||!1)},editExistingJob:function(e){this.editMode=!0;var t=this;this.model.clear({silent:!0}),this._render(),this.changeActiveTab("scheduleTab"),this.model.id=e,this.prepareSaveOrSubmitButton(),this.model.fetch({success:function(){t.setTitle(t.model.get("label"))}})},prepareSaveOrSubmitButton:function(){var e=this.$el.find("[name=openSaveDialog]"),i=this.$el.find(".footer #cancel");e.attr("disabled","disabled").addClass("disabled"),i.attr("disabled",null).removeClass("disabled"),this.saveButtonReady=new t.Deferred,this.saveButtonReady.done(function(){e.attr("disabled",null).removeClass("disabled")})},InputControlsLoaded:function(){this.saveButtonReady.resolve()},InputControlsNotLoaded:function(){this.saveButtonReady.resolve(),this.toggleEnableTab("parametersTab",!1)},setRunNowMode:function(e){this.runNowMode=!!e},_render:function(){var e={i18n:s,reportUri:this.options.reportUri,runNowMode:this.runNowMode};this.setElement(t(i.template(u,i.extend({},e)))),this.runNowMode&&this.$el.find("li[data-tab=scheduleTab]").addClass("disabled"),this.tabs.scheduleTab.render(),this.tabs.parametersTab.render(),this.tabs.outputTab.render(),this.tabs.notificationsTab.render(),this.$el.find("[name=scheduleTab]").append(this.tabs.scheduleTab.$el),this.$el.find("[name=parametersTab]").append(this.tabs.parametersTab.$el),this.$el.find("[name=outputTab]").append(this.tabs.outputTab.$el),this.$el.find("[name=notificationsTab]").append(this.tabs.notificationsTab.$el),this.currentActiveTabName=""},setTitle:function(e){this.$el.find(".header .title").text(e)},changeActiveTab:function(e){e&&("error"===e&&(e=this.$el.find("[name=tabHolder] > div").find(".error").first().parents(".tab").attr("name")),this.currentActiveTabName!==e&&(this.$el.find("[name=tabs] li").removeClass("selected").filter("[data-tab="+e+"]").addClass("selected"),this.$el.find("[name=tabHolder] > div").addClass("hidden").filter("[name="+e+"]").removeClass("hidden"),this.currentActiveTabName=e))},toggleEnableTab:function(e,t){var i=this.$el.find("[name=tabs] li").filter("[data-tab="+e+"]");i.attr("disabled",!t).toggleClass("disabled",!t),!t&&i.hasClass("selected")&&this.changeActiveTab(i.nextAll(":not(.disabled):first").data("tab"))},sourceKeyInModelChanged:function(e,t){var r;if(this.dontReactOnModelChange!==!0){t.parameters&&(r=1===i.keys(t.parameters.parameterValues).length,r&=!!t.parameters.parameterValues.REPORT_TIME_ZONE);var a=t.parameters&&!r;a||this.saveButtonReady.resolve(),this.toggleEnableTab("parametersTab",a),this.$el.find(".schedule_for").find(".path").text(t.reportUnitURI)}},_prepareSaveDialog:function(){this.saveDialog&&this.saveDialog.remove();var e=this;this.saveDialog=new n(i.extend({},this.options,{model:this.model,onSaveDone:i.bind(this._onSaveDone,this),onSaveFail:i.bind(this._onSaveFail,this)})),this.listenTo(this.saveDialog,"saveValidationFailed",function(){e.saveDialog.closeDialog()})},startSavingProcess:function(){return this.model.isValid(this.editMode)?(this._prepareSaveDialog(),void this.saveDialog.startSaveDialog()):void this.changeActiveTab("error")},_onSaveDone:function(){this.trigger("jobHasBeenCreated")},_onSaveFail:function(e,t,r){this.saveDialog.closeDialog();var a=this,n=!1,l=!1,d=!1;try{n=JSON.parse(t.responseText)}catch(h){}if(n.error&&(n=n.error),i.isArray(n)||(n=[n]),i.each(n,function(e){var t="",i="";if("mandatory.parameter.error"===e.errorCode&&(t=s["report.scheduling.saveDialog.parameterIsMissing"],e.parameters&&e.parameters[0]&&(i=e.parameters[0].substr(e.parameters[0].indexOf(".")+1))),"error.duplicate.report.job.output.filename"===e.errorCode&&(i="baseOutputFilename",t=s["error.duplicate.report.job.output.filename"].replace("{0}",e.errorArguments[0]).replace("{1}",e.errorArguments[1])),e.message&&-1!==e.message.indexOf("will never fire")&&(i="triggerWillNeverFire",t=s["error.report.job.trigger.no.fire"]),"error.pattern"===e.errorCode&&("trigger.hours"===e.field&&(i="hours",t=s["error.pattern.trigger.hours"]),"trigger.minutes"===e.field&&(i="minutes",t=s["error.pattern.trigger.minutes"]),"trigger.monthDays"===e.field&&(i="datesInMonth",t=s["error.pattern.trigger.monthDays"]),"contentRepositoryDestination.timestampPattern"===e.field&&(i="timestampPattern",t=s["error.pattern.contentRepositoryDestination.timestampPattern"])),"resource.not.found"===e.errorCode){var r=new o({modal:!0,additionalCssClasses:"schedulerJobRemovedAlertDialog"});return r.setMessage(s["report.scheduling.editing.jobHasBeenRemoved"]),a.listenTo(r,"close",function(){a.trigger("errorEditingJob")}),r.open(),void(l=!0)}""!==t&&(a.showValidationMessage("error",{field:i,message:t}),d=!0)}),l!==!0&&(d&&this.changeActiveTab("error"),d===!1)){var c=s["report.scheduling.editing.failedToSave"]+".";n[0]&&n[0].errorCode?c+="<br/>The reason is: "+n[0].errorCode:n.message&&(c+="<br/>The reason is: "+n.message),c+="<br/><br/>The full response from the server is: "+t.responseText,dialogs.errorPopup.show(c)}},clearAllValidationErrors:function(){this.$el.find(".error").removeClass("error")},validModelListener:function(e){var t=this;i.each(e,function(e){t.showValidationMessage("success",e)})},invalidModelListener:function(e,t){var r=this;i.each(e,function(e){r.showValidationMessage("error",e)}),t&&t.switchToErrors&&r.changeActiveTab("error")},showValidationMessage:function(e,t){if(t.field){"contentRepositoryDestination.folderURI"===t.field&&(t.field="contentRepositoryDestination.outputRepository"),t.field=t.field.replace("trigger.",""),t.field=t.field.replace("mailNotification.",""),t.field=t.field.replace("contentRepositoryDestination.","");var i=this.$el.find(".warning[data-field="+t.field+"]");i.parent().addClass("error"),i.removeClass("success").removeClass("error"),i.addClass(e);var r="";if(t.message)r=t.message;else if(t.errorCode){if(r=s[t.errorCode],!r)return;if(t.errorArguments)for(var a=0,o=t.errorArguments.length;o>a;a++)r=r.replace("{"+a+"}",t.errorArguments[a])}""!==r&&i.text(r)}}})});