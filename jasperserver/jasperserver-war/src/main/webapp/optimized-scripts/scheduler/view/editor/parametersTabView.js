define(["require","controls.options","controls.controller","jquery","underscore","bundle!all","jrs.configs","backbone","text!scheduler/template/editor/parametersTabTemplate.htm"],function(e){"use strict";e("controls.options"),e("controls.controller");var t=e("jquery"),o=e("underscore"),r=e("bundle!all"),i=e("jrs.configs"),n=e("backbone"),s=e("text!scheduler/template/editor/parametersTabTemplate.htm");return o.extend(ControlsBase,i.inputControlsConstants),n.View.extend({events:{"click [name=saveCurrentValuesButton]":"saveCurrentValuesClick"},initialize:function(e){this.options=o.extend({},e),this.listenTo(this.model,"change:source",this.sourceChange),this.listenTo(this.model,"change:source",this.sourceChange2),t(document).on("viewmodel:values:changed",o.bind(this.viewModelValuesChange,this))},remove:function(){this.reportOptionsDialog&&this.reportOptionsDialog.remove(),n.View.prototype.remove.apply(this,arguments)},render:function(){this.setElement(t(o.template(s,{i18n:r,config:i}))),i.isProVersion&&(this.reportOptions=new JRS.Controls.ReportOptions,t(document).on("viewmodel:selection:changed",o.bind(this.viewModelSelectionChange,this)),this.reportOptionsDialog=new OptionsDialog({"button#saveAsBtnSave":o.bind(this.saveAsDialogButtonSaveClick,this),"button#saveAsBtnCancel":o.bind(this.saveAsDialogButtonCancelClick,this)}))},saveCurrentValuesClick:function(){this.reportOptionsDialog.show()},saveAsDialogButtonSaveClick:function(){var e=this,o=this.reportOptionsDialog.input.getValue(),r=this.model.controlsController.getViewModel().get("selection"),i=o===this.reportOptionsDialog.optionNameToOverwrite;t.when(this.reportOptions.add(this.reportOptions.optionsUrl||this.reportOptions.url,o,r,i)).done(function(){e.reportOptionsDialog.hideWarning();var t=e.reportOptions.getElem().parent();0===t.length&&(t=e.$el.find(".saveCurrentValuesContainer"),t.prepend(e.reportOptions.getElem())),e.reportOptionsDialog.hide(),delete e.reportOptionsDialog.optionNameToOverwrite}).fail(function(r){try{var n=t.parseJSON(r.responseText);"report.options.dialog.confirm.message"===n.errorCode&&!i&&(e.reportOptionsDialog.optionNameToOverwrite=o),e.reportOptionsDialog.showWarning(n.message)}catch(s){}})},saveAsDialogButtonCancelClick:function(){this.reportOptionsDialog.hide()},sourceChange:function(e,t){var o=t&&t.reportUnitURI,r=this.model.get("source").parameters;if(r){var i=r.parameterValues;for(var n in i)i.hasOwnProperty(n)&&null===i[n]&&delete i[n];this.reportOptions&&(this.reportOptions.url=void 0),this.model.controlsController=new JRS.Controls.Controller({reportUri:o,reportOptionUri:"",preSelectedData:i});var s=this;this.model.controlsController.fetchControlsStructure(i).done(function(){s.trigger("IC_Displayed")}).fail(function(){s.trigger("failedToGet_IC")})}},sourceChange2:function(e,o){var r=this,i=o&&o.reportUnitURI;if(this.reportOptions&&i!==this.reportOptions.url){this.reportOptions.optionsUrl=void 0,this.model.resource("reportOptions",function(e,o){e||(r.reportOptions.optionsUrl=o.reportUri,t.when(r.reportOptions.fetch(o.reportUri||i,"")).done(function(){r.$el.find(".saveCurrentValuesContainer").prepend(r.reportOptions.getElem()),t(document).trigger("viewmodel:selection:changed")}))});var n=this.model.get("repositoryDestination").folderURI;this.model.checkPermissionOnFolder(n,function(e,t){var o=!1;e||(o=1===t||30===t),r.$el.find("[name=saveCurrentValuesButton]").attr("disabled",o?null:"disabled")}),this.reportOptions.url=i}},viewModelValuesChange:function(){this.model.set("source",{reportUnitURI:this.model.get("source").reportUnitURI,parameters:{parameterValues:this.model.controlsController.getViewModel().get("selection")}},{validate:!1,silent:!0})},viewModelSelectionChange:function(){var e=this.reportOptions.find({uri:this.reportOptions.url});this.reportOptions.set({selection:e},!0)}})});