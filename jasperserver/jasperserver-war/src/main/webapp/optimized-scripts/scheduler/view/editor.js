define("scheduler/view/editor",["require","jquery","backbone","scheduler/model/job","bundle!jasperserver_messages","scheduler/view/editor/schedule","scheduler/view/editor/parameters","scheduler/view/editor/output","scheduler/view/editor/notifications","scheduler/util/jobUtil","underscore"],function(e){var t=e("jquery"),s=e("backbone"),a=e("scheduler/model/job"),r=e("bundle!jasperserver_messages"),i=e("scheduler/view/editor/schedule"),d=e("scheduler/view/editor/parameters"),o=e("scheduler/view/editor/output"),l=e("scheduler/view/editor/notifications"),n=e("scheduler/util/jobUtil"),u=e("underscore");return s.View.extend({el:"#scheduler_editor",editMode:!1,initialize:function(e){var s,n=this,c=this;e.app&&(n.app=e.app),n.model=new a,n.tabs=n.$(".tabs li"),n.pages=n.$("div.tab"),s={app:n.app,model:n.model,editor:this},n.tabs.schedule=new i(s),n.tabs.parameters=new d(s),n.tabs.output=new o(s),n.tabs.notifications=new l(s),n.header=n.$(".schedule_for"),n.title=n.$(".header .title"),n.location=n.header.find(".path"),n.dialog=t("#saveAs"),n.dialog.find("#saveAsInputName").attr("maxlength",100),n.dialog.find(".groupBox").remove(),n.dialog.find("[for=saveAsInputName] > span:first").text(r["report.scheduling.job.edit.specify.scheduledjobname.required"]),n.dialog.find("[for=saveAsInputDescription] > span:first").text(r["report.scheduling.job.edit.specify.schedule.description"]),n.tabs.on("touchend mouseup",function(e,s){return n.model.isValid(n.editMode)?(n.select(t(this).data("tab")),!1):(n.select("error"),!1)}),n.model.on("clearAllErrors",function(){n.$(".error").removeClass("error")}),n.model.on("valid",function(e,t){u.each(t,function(e){n.message("success",e)})}),n.model.on("invalid error",function(e,t,s){u.each(t,function(e){n.message("error",e)}),s&&s.switchToErrors&&n.select("error")}),n.model.on("change:source",function(e,t){var s;if(n.dontReactOnModelChange!==!0){t.parameters&&(s=1===u.keys(t.parameters.parameterValues).length,s&=!!t.parameters.parameterValues.REPORT_TIME_ZONE);var a=t.parameters&&!s;a||n.saveButtonReady.resolve(),n.state("parameters",a),n.location.text(t.reportUnitURI)}}),this.model.on("saveValidationFailed",function(){c.suspendOrResumeAllSaveButtons("resume")}),this.tabs.parameters.on("ICLoaded",u.bind(this.InputControlsLoaded,this)),this.tabs.parameters.on("failedToLoadIC",u.bind(this.InputControlsNotLoaded,this)),n.save={validate:!1,success:u.bind(n.back,n),error:function(e,t){n.suspendOrResumeAllSaveButtons("resume");try{t=JSON.parse(t.responseText)}catch(s){return!1}t.message&&-1!==t.message.indexOf("will never fire")?n.model.trigger("error",n.model,[{field:"triggerWillNeverFire",errorCode:"error.report.job.trigger.no.fire"}]):n.model.trigger("error",n.model,t.error),n.select("error")}},n.$("[data-action=save]").click(function(){n.submitOrSaveAction()}),n.$("[data-action=submit]").click(function(){n.model.set("label","Immediate Execution"),n.submitOrSaveAction()}),n.dialog.on("click","#saveAsBtnSave",function(){n.saveAsFormValidation!==!1&&(n.model.set("label",n.dialog.find("#saveAsInputName").val()),n.model.set("description",n.dialog.find("#saveAsInputDescription").val()),n.suspendOrResumeAllSaveButtons("suspend"),n.model.save({},n.save))}),n.$("#cancel").click(u.bind(n.back,n))},back:function(){n.back("fast"===this.option&&this.app._runNowClick===!1?n.SCHEDULER_BACK_COOKIE_NAME:n.SCHEDULER_LIST_BACK_COOKIE_NAME)},submitOrSaveAction:function(){var e=this;return e.model.isValid(e.editMode)?(e.model.id||e.model.get("label")?(e.dialog.find("#saveAsInputName").val(e.model.get("label")),e.dialog.find("#saveAsInputDescription").val(e.model.get("description"))):(e.dialog.find("#saveAsInputName").val(""),e.dialog.find("#saveAsInputDescription").val("")),e.saveAsFormValidation=!1,dialogs.popupConfirm.show(e.dialog.get(0),!1,{okButtonSelector:"#saveAsBtnSave",cancelButtonSelector:"#saveAsBtnCancel",validateFunc:function(){var t=e.dialog.find("#saveAsInputName").val();return e.dialog.find("#saveAsInputName").parent().removeClass("error"),e.dialog.find("#saveAsInputName").next().text(""),""===t?(e.dialog.find("#saveAsInputName").parent().addClass("error"),e.dialog.find("#saveAsInputName").next().text(r["report.scheduling.job.edit.specify.scheduledjobname"]),e.saveAsFormValidation=!1,!1):(e.saveAsFormValidation=!0,!0)}}),void e.dialog.find("input:first").focus()):void e.select("error")},select:function(e){if("error"===e&&(e=this.$(".error").first().parents(".tab").data("tab")),e){if(this.tabs.current){if(e===this.tabs.current.data("tab"))return;var t=this.pages.current.find("input.error, select.error");if(t.length)return}var s=this.tabs.filter("[data-tab="+e+"]"),a=this.pages.filter("[data-tab="+e+"]");s.hasClass("disabled")||s.attr("disabled")||(e&&this.app.router.navigate(location.hash.substr(1).replace(/(\$[^@\/]*)?(@.*)?$/,"$1@"+e),{replace:!0}),this.header.attr("data-tab-current",e),s.siblings().removeClass("selected"),this.tabs.current=s.addClass("selected"),a.siblings(".tab").addClass("hidden"),this.pages.current=a.removeClass("hidden"))}},message:function(e,t){if(t.field){"contentRepositoryDestination.folderURI"===t.field&&(t.field="contentRepositoryDestination.outputRepository"),t.field=t.field.replace("trigger.",""),t.field=t.field.replace("mailNotification.",""),t.field=t.field.replace("contentRepositoryDestination.","");var s=this.$(".warning[data-field="+t.field+"]");if(s.parent().addClass("error"),s.removeClass("success").removeClass("error"),s.addClass(e),t.errorCode){var a=r[t.errorCode];if(!a)return;if(t.errorArguments)for(var i=0,d=t.errorArguments.length;d>i;i++)a=a.replace("{"+i+"}",t.errorArguments[i]);s.text(a)}}},state:function(e,t){var s=this.tabs.filter("[data-tab="+e+"]");s.attr("disabled",!t),s.toggleClass("disabled",!t),!t&&s.hasClass("selected")&&this.select(s.nextAll(":not(.disabled):first").data("tab"))},edit:function(e,t){this.editMode=!0;var s=this;s.model.clear({silent:!0}),s.app.page(s),s.$("#submit").addClass("hidden"),s.state("schedule",!0),s.select(t||"schedule"),s.model.id=e,s.title.text(""),this.suspendOrResumeAllSaveButtons("resume"),this.prepareSaveOrSubmitButton(),s.model.fetch({success:function(){s.title.text(s.model.get("label"))}})},create:function(e,t,s){var a=this;a.model.clear({silent:!0}),a.editMode=!1,a.option=s,a.title.text(r["report.scheduling.new.schedule"]),a.app.page(a),a.state("schedule","fast"!==a.option),a.select(t||"schedule"),this.dontReactOnModelChange=!0,a.model.createFromUri(e),this.dontReactOnModelChange=!1;var i=a.$(".footer #save").addClass("hidden disabled").attr("disabled","disabled"),d=a.$(".footer #submit").addClass("hidden disabled").attr("disabled","disabled");"fast"===a.option?d.removeClass("hidden"):i.removeClass("hidden"),this.suspendOrResumeAllSaveButtons("resume"),this.prepareSaveOrSubmitButton(),a.model.parameters(this.parentReportURI||!1,function(e,t){if(t&&t.inputControl){for(var s={},r=t.inputControl,i=0,d=r.length;d>i;i++)s[r[i].id]=null;a.model.update("source",{parameters:{parameterValues:s}})}else a.saveButtonReady.resolve(),a.state("parameters",!1)})},InputControlsLoaded:function(){this.saveButtonReady.resolve()},InputControlsNotLoaded:function(){this.saveButtonReady.resolve(),this.state("parameters",!1)},prepareSaveOrSubmitButton:function(){var e=!1,s=this.$(".footer #save"),a=this.$(".footer #submit");this.editMode||"fast"!==this.option||(e=!0),s.attr("disabled","disabled").addClass("disabled"),a.attr("disabled","disabled").addClass("disabled"),s[e?"addClass":"removeClass"]("hidden"),a[e?"removeClass":"addClass"]("hidden"),this.saveButtonReady=new t.Deferred,this.saveButtonReady.done(function(){s.attr("disabled",null).removeClass("disabled"),a.attr("disabled",null).removeClass("disabled")})},suspendOrResumeAllSaveButtons:function(e){var t=this.$(".footer #save"),s=this.$(".footer #submit"),a=this.$(".footer #cancel");t.attr("disabled","suspend"===e?"disabled":null),s.attr("disabled","suspend"===e?"disabled":null),a.attr("disabled","suspend"===e?"disabled":null),t.toggleClass("disabled","suspend"===e),s.toggleClass("disabled","suspend"===e),a.toggleClass("disabled","suspend"===e)}})});