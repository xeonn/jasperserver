define("scheduler/view/editor",["require","jquery","backbone","scheduler/model/job","bundle!jasperserver_messages","scheduler/view/editor/schedule","scheduler/view/editor/parameters","scheduler/view/editor/output","scheduler/view/editor/notifications","scheduler/util/jobUtil","underscore"],function(e){var t=e("jquery"),a=e("backbone"),r=e("scheduler/model/job"),s=e("bundle!jasperserver_messages"),i=e("scheduler/view/editor/schedule"),o=e("scheduler/view/editor/parameters"),d=e("scheduler/view/editor/output"),l=e("scheduler/view/editor/notifications"),n=e("scheduler/util/jobUtil"),c=e("underscore");return a.View.extend({el:"#scheduler_editor",editMode:!1,initialize:function(e){var a,n=this;e.app&&(n.app=e.app),n.model=new r,n.tabs=n.$(".tabs li"),n.pages=n.$("div.tab"),a={app:n.app,model:n.model},n.tabs.schedule=new i(a),n.tabs.parameters=new o(a),n.tabs.output=new d(a),n.tabs.notifications=new l(a),n.header=n.$(".schedule_for"),n.title=n.$(".header .title"),n.location=n.header.find(".path"),n.dialog=t("#saveAs"),n.dialog.find("#saveAsInputName").attr("maxlength",100),n.dialog.find(".groupBox").remove(),n.dialog.find("[for=saveAsInputName] > span:first").text(s["report.scheduling.job.edit.specify.scheduledjobname.required"]),n.dialog.find("[for=saveAsInputDescription] > span:first").text(s["report.scheduling.job.edit.specify.schedule.description"]),n.tabs.on("touchend mouseup",function(){return n.model.isValid(n.editMode)?(n.select(t(this).data("tab")),!1):(n.select("error"),!1)}),n.model.on("clearAllErrors",function(){n.$(".error").removeClass("error")}),n.model.on("valid",function(e,t){c.each(t,function(e){n.message("success",e)})}),n.model.on("invalid error",function(e,t,a){c.each(t,function(e){n.message("error",e)}),a&&a.switchToErrors&&n.select("error")}),n.model.on("change:source",function(e,t){var a;t.parameters&&(a=1===c.keys(t.parameters.parameterValues).length,a&=!!t.parameters.parameterValues.REPORT_TIME_ZONE),n.state("parameters",t.parameters&&!a),n.location.text(t.reportUnitURI)}),n.save={validate:!1,success:c.bind(n.back,n),error:function(e,t){try{t=JSON.parse(t.responseText)}catch(a){return!1}t.message&&-1!==t.message.indexOf("will never fire")?n.model.trigger("error",n.model,[{field:"triggerWillNeverFire",errorCode:"error.report.job.trigger.no.fire"}]):n.model.trigger("error",n.model,t.error),n.select("error")}},n.$("[data-action=save]").click(function(){n.submitOrSaveAction()}),n.$("[data-action=submit]").click(function(){n.model.set("label","Immediate Execution"),n.submitOrSaveAction()}),n.dialog.on("click","#saveAsBtnSave",function(){n.saveAsFormValidation!==!1&&(n.model.set("label",n.dialog.find("#saveAsInputName").val()),n.model.set("description",n.dialog.find("#saveAsInputDescription").val()),n.model.save({},n.save))}),n.$("#cancel").click(c.bind(n.back,n))},back:function(){n.back("fast"===this.option&&this.app._runNowClick===!1?n.SCHEDULER_BACK_COOKIE_NAME:n.SCHEDULER_LIST_BACK_COOKIE_NAME)},submitOrSaveAction:function(){var e=this;return e.model.isValid(e.editMode)?(e.model.id||e.model.get("label")?(e.dialog.find("#saveAsInputName").val(e.model.get("label")),e.dialog.find("#saveAsInputDescription").val(e.model.get("description"))):(e.dialog.find("#saveAsInputName").val(""),e.dialog.find("#saveAsInputDescription").val("")),e.saveAsFormValidation=!1,dialogs.popupConfirm.show(e.dialog.get(0),!1,{okButtonSelector:"#saveAsBtnSave",cancelButtonSelector:"#saveAsBtnCancel",validateFunc:function(){var t=e.dialog.find("#saveAsInputName").val();return e.dialog.find("#saveAsInputName").parent().removeClass("error"),e.dialog.find("#saveAsInputName").next().text(""),""===t?(e.dialog.find("#saveAsInputName").parent().addClass("error"),e.dialog.find("#saveAsInputName").next().text(s["report.scheduling.job.edit.specify.scheduledjobname"]),e.saveAsFormValidation=!1,!1):(e.saveAsFormValidation=!0,!0)}}),void e.dialog.find("input:first").focus()):void e.select("error")},select:function(e){if("error"===e&&(e=this.$(".error").first().parents(".tab").data("tab")),e){if(this.tabs.current){if(e===this.tabs.current.data("tab"))return;var t=this.pages.current.find("input.error, select.error");if(t.length)return}var a=this.tabs.filter("[data-tab="+e+"]"),r=this.pages.filter("[data-tab="+e+"]");a.hasClass("disabled")||a.attr("disabled")||(e&&this.app.router.navigate(location.hash.substr(1).replace(/(\$[^@\/]*)?(@.*)?$/,"$1@"+e),{replace:!0}),this.header.attr("data-tab-current",e),a.siblings().removeClass("selected"),this.tabs.current=a.addClass("selected"),r.siblings(".tab").addClass("hidden"),this.pages.current=r.removeClass("hidden"))}},message:function(e,t){if(t.field){"contentRepositoryDestination.folderURI"===t.field&&(t.field="contentRepositoryDestination.outputRepository"),t.field=t.field.replace("trigger.",""),t.field=t.field.replace("mailNotification.",""),t.field=t.field.replace("contentRepositoryDestination.","");var a=this.$(".warning[data-field="+t.field+"]");if(a.parent().addClass("error"),a.removeClass("success").removeClass("error"),a.addClass(e),t.errorCode){var r=s[t.errorCode];if(!r)return;if(t.errorArguments)for(var i=0,o=t.errorArguments.length;o>i;i++)r=r.replace("{"+i+"}",t.errorArguments[i]);a.text(r)}}},state:function(e,t){var a=this.tabs.filter("[data-tab="+e+"]");a.attr("disabled",!t),a.toggleClass("disabled",!t),!t&&a.hasClass("selected")&&this.select(a.nextAll(":not(.disabled):first").data("tab"))},edit:function(e,t){this.editMode=!0;var a=this;a.app.page(a),a.$("#submit").addClass("hidden"),a.state("schedule",!0),a.select(t||"schedule"),a.model.id=e,a.title.text(""),a.$("#save").removeClass("hidden"),a.model.fetch({success:function(){a.title.text(a.model.get("label"))}})},create:function(e,t,a){var r=this;r.editMode=!1,r.option=a,r.title.text(s["report.scheduling.new.schedule"]),r.app.page(r),r.state("schedule","fast"!==r.option),r.select(t||"schedule"),r.model.createFromUri(e);var i,o=r.$(".footer #save").addClass("hidden disabled").attr("disabled","disabled"),d=r.$(".footer #submit").addClass("hidden disabled").attr("disabled","disabled");"fast"===r.option?(d.removeClass("hidden"),i=d):(o.removeClass("hidden"),i=o),r.model.parameters(this.parentReportURI||!1,function(e,t){if(t&&t.inputControl){for(var a={},s=t.inputControl,o=0,d=s.length;d>o;o++)a[s[o].id]=null;r.model.update("source",{parameters:{parameterValues:a}})}i.removeClass("disabled").attr("disabled",null)})}})});