define("scheduler/view/editor",["require","jquery","backbone","scheduler/model/job","bundle!jasperserver_messages","scheduler/view/editor/schedule","scheduler/view/editor/parameters","scheduler/view/editor/output","scheduler/view/editor/notifications","scheduler/util/jobUtil","underscore"],function(e){var t=e("jquery"),r=e("backbone"),a=e("scheduler/model/job"),s=e("bundle!jasperserver_messages"),i=e("scheduler/view/editor/schedule"),o=e("scheduler/view/editor/parameters"),d=e("scheduler/view/editor/output"),n=e("scheduler/view/editor/notifications"),l=e("scheduler/util/jobUtil"),c=e("underscore");return r.View.extend({el:"#scheduler_editor",editMode:!1,initialize:function(e){var r,l=this;e.app&&(l.app=e.app),l.model=new a,l.tabs=l.$(".tabs li"),l.pages=l.$("div.tab"),r={app:l.app,model:l.model},l.tabs.schedule=new i(r),l.tabs.parameters=new o(r),l.tabs.output=new d(r),l.tabs.notifications=new n(r),l.header=l.$(".schedule_for"),l.title=l.$(".header .title"),l.location=l.header.find(".path"),l.dialog=t("#saveAs"),l.dialog.find("#saveAsInputName").attr("maxlength",100),l.dialog.find(".groupBox").remove(),l.dialog.find("[for=saveAsInputName] > span:first").text(s["report.scheduling.job.edit.specify.scheduledjobname.required"]),l.dialog.find("[for=saveAsInputDescription] > span:first").text(s["report.scheduling.job.edit.specify.schedule.description"]),l.tabs.on("touchend mouseup",function(){return l.model.isValid(l.editMode)?(l.select(t(this).data("tab")),!1):(l.select("error"),!1)}),l.model.on("clearAllErrors",function(){l.$(".error").removeClass("error")}),l.model.on("valid",function(e,t){c.each(t,function(e){l.message("success",e)})}),l.model.on("invalid error",function(e,t,r){c.each(t,function(e){l.message("error",e)}),r&&r.switchToErrors&&l.select("error")}),l.model.on("change:source",function(e,t){var r;t.parameters&&(r=1===c.keys(t.parameters.parameterValues).length,r&=!!t.parameters.parameterValues.REPORT_TIME_ZONE),l.state("parameters",t.parameters&&!r),l.location.text(t.reportUnitURI)}),l.save={validate:!1,success:c.bind(l.back,l),error:function(e,t){try{t=JSON.parse(t.responseText)}catch(r){return!1}t.message&&-1!==t.message.indexOf("will never fire")?l.model.trigger("error",l.model,[{field:"triggerWillNeverFire",errorCode:"error.report.job.trigger.no.fire"}]):l.model.trigger("error",l.model,t.error),l.select("error")}},l.$("[data-action=save]").click(function(){l.submitOrSaveAction()}),l.$("[data-action=submit]").click(function(){l.model.set("label","Immediate Execution"),l.submitOrSaveAction()}),l.dialog.on("click","#saveAsBtnSave",function(){l.saveAsFormValidation!==!1&&(l.model.set("label",l.dialog.find("#saveAsInputName").val()),l.model.set("description",l.dialog.find("#saveAsInputDescription").val()),l.model.save({},l.save))}),l.$("#cancel").click(c.bind(l.back,l))},back:function(){l.back("fast"===this.option&&this.app._runNowClick===!1?l.SCHEDULER_BACK_COOKIE_NAME:l.SCHEDULER_LIST_BACK_COOKIE_NAME)},submitOrSaveAction:function(){var e=this;return e.model.isValid(e.editMode)?(e.model.id||e.model.get("label")?(e.dialog.find("#saveAsInputName").val(e.model.get("label")),e.dialog.find("#saveAsInputDescription").val(e.model.get("description"))):(e.dialog.find("#saveAsInputName").val(""),e.dialog.find("#saveAsInputDescription").val("")),e.saveAsFormValidation=!1,dialogs.popupConfirm.show(e.dialog.get(0),!1,{okButtonSelector:"#saveAsBtnSave",cancelButtonSelector:"#saveAsBtnCancel",validateFunc:function(){var t=e.dialog.find("#saveAsInputName").val();return e.dialog.find("#saveAsInputName").parent().removeClass("error"),e.dialog.find("#saveAsInputName").next().text(""),""==t?(e.dialog.find("#saveAsInputName").parent().addClass("error"),e.dialog.find("#saveAsInputName").next().text(s["report.scheduling.job.edit.specify.scheduledjobname"]),e.saveAsFormValidation=!1,!1):(e.saveAsFormValidation=!0,!0)}}),void e.dialog.find("input:first").focus()):void e.select("error")},select:function(e){if("error"===e&&(e=this.$(".error").first().parents(".tab").data("tab")),e){if(this.tabs.current){if(e===this.tabs.current.data("tab"))return;var t=this.pages.current.find("input.error, select.error");if(t.length)return}var r=this.tabs.filter("[data-tab="+e+"]"),a=this.pages.filter("[data-tab="+e+"]");r.hasClass("disabled")||r.attr("disabled")||(e&&this.app.router.navigate(location.hash.substr(1).replace(/(\$[^@\/]*)?(@.*)?$/,"$1@"+e),{replace:!0}),this.header.attr("data-tab-current",e),r.siblings().removeClass("selected"),this.tabs.current=r.addClass("selected"),a.siblings(".tab").addClass("hidden"),this.pages.current=a.removeClass("hidden"))}},message:function(e,t){if(t.field){"contentRepositoryDestination.folderURI"===t.field&&(t.field="contentRepositoryDestination.outputRepository"),t.field=t.field.replace("trigger.",""),t.field=t.field.replace("mailNotification.",""),t.field=t.field.replace("contentRepositoryDestination.","");var r=this.$(".warning[data-field="+t.field+"]");if(r.parent().addClass("error"),r.removeClass("success").removeClass("error"),r.addClass(e),t.errorCode){var a=s[t.errorCode];if(!a)return;if(t.errorArguments)for(var i=0,o=t.errorArguments.length;o>i;i++)a=a.replace("{"+i+"}",t.errorArguments[i]);r.text(a)}}},state:function(e,t){var r=this.tabs.filter("[data-tab="+e+"]");r.attr("disabled",!t),r.toggleClass("disabled",!t),!t&&r.hasClass("selected")&&this.select(r.nextAll(":not(.disabled):first").data("tab"))},edit:function(e,t){this.editMode=!0;var r=this;r.app.page(r),r.$("#submit").addClass("hidden"),r.state("schedule",!0),r.select(t||"schedule"),r.model.id=e,r.title.text(""),r.$("#save").removeClass("hidden"),r.model.fetch({success:function(){r.title.text(r.model.get("label"))}})},create:function(e,t,r){var a=this;a.editMode=!1,a.option=r,a.title.text(s["report.scheduling.new.schedule"]),a.app.page(a),a.state("schedule","fast"!==a.option),a.select(t||"schedule"),a.model.createFromUri(e),a.model.parameters(this.parentReportURI||!1,function(e,t){if(t&&t.inputControl){for(var r={},s=t.inputControl,i=0,o=s.length;o>i;i++)r[s[i].id]=null;a.model.update("source",{parameters:{parameterValues:r}})}}),a.$(".footer #save")["fast"===a.option?"addClass":"removeClass"]("hidden"),a.$(".footer #submit")["fast"!==a.option?"addClass":"removeClass"]("hidden")}})});