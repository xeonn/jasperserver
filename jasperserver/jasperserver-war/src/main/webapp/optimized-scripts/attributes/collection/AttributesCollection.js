define(["require","underscore","jquery","json3","backbone","common/transport/request","components.templateengine","serverSettingsCommon/enum/serverSettingGroupsEnum","attributes/enum/levelIdEnum"],function(e){var t=e("underscore"),n=e("jquery"),r=e("json3"),i=e("backbone"),o=e("common/transport/request"),a=e("components.templateengine"),s=e("serverSettingsCommon/enum/serverSettingGroupsEnum"),u=e("attributes/enum/levelIdEnum"),c={TENANT:"tenant:/",USER:"user:/"},l=i.Collection.extend({initialize:function(e,t){t=t||{};var n="rest_v2/attributes?_embedded=permission",r=n+"&group="+s.CUSTOM,i=t.context||{};this.urlGETTemplate=i.urlGETTemplate||r,this.urlPUTTemplate=i.urlPUTTemplate||n},parse:function(e){return e&&e.attribute?e.attribute:[]},setContext:function(e){e=e||{urlGETTemplate:this.urlGETTemplate,urlPUTTemplate:this.urlPUTTemplate};var r=new n.Deferred;return t.isEqual(this.context,e)?r.resolve():(this.context=e,this.fetch({reset:!0,headers:{Accept:"application/attributes.collection.hal+json"}}).done(r.resolve)),r},getContext:function(){return this.context},url:function(e){var n=t.extend({},this.context),r="PUT"===e?this.urlPUTTemplate:this.urlGETTemplate;return t.each(u,function(e){n[e]&&(n[e]=this.escapeLevelId(n[e]))},this),a.renderUrl(r,n,!1)},escapeLevelId:function(e){return encodeURIComponent(e).replace("'","%27")},save:function(e,t){var n="PUT",i=this._modelsToJSON(t,!0),a="application/hal+json";return o({url:this.url(n)+this._concatNames(e),type:"PUT",contentType:a,headers:{Accept:a},data:r.stringify({attribute:i})})},validateSearch:function(e,n,r,i){var o="&recursive=true",a=i&&this._concatGroups();return this.search(e,n,o,r,a).done(t.bind(this._successSearchCallback,this,e,n))},search:function(e,t,n,r,i){n=n||"",i=i||"";var a="application/attributes.collection.hal+json";return o({url:this.url()+this._concatNames(e,r)+n+i,type:"GET",dataType:"json",contentType:a,headers:{Accept:a}})},getHolder:function(){return this.context.id?c.TENANT+this.context.id:this.context.tenantId?c.USER+this.context.tenantId+"/"+this.context.userName:c.TENANT},addItemsToCollection:function(e){!t.isArray(e)&&(e=[e]),t.each(e,function(e){this.add(e)},this)},_modelsToJSON:function(e,n){return t.map(e,function(e){return e.toJSON({omitValue:n})})},_successSearchCallback:function(e,n,r){e=t.isArray(e)?e:[e],n=this._modelsToJSON(n);var i,o,a=this.getHolder();t.each(e,function(e){o=a?a:e.holder,e.holder=o,r&&r.attribute.length&&(e.attr=r.attribute),n&&t.where(n,{name:e.get("name"),inherited:!1}).length>1&&(i={holder:o},e.attr?e.attr.push(i):e.attr=[i])},this)},_concatGroups:function(){var e="";return t.each(t.omit(s,"CUSTOM"),function(t){e+="&group="+t}),e},_concatNames:function(e,n){e=t.isArray(e)?e:[e];var r,i="",o=this,a=function(e){return"&name="+o.escapeLevelId(e)};return t.each(e,function(e){r=e.get("id"),!n&&e.isRenamed()&&r&&(i+=a(r)),i+=a(e.get("name"))},this),i}});return l});