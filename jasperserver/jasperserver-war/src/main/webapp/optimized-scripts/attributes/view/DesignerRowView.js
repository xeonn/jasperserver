define(["require","underscore","jquery","attributes/view/RowView","serverSettingsCommon/enum/confirmDialogTypesEnum","attributes/enum/permissionMasksEnum","attributes/factory/rowTemplatesFactory"],function(e){var t=e("underscore"),i=e("jquery"),n=e("attributes/view/RowView"),o=e("serverSettingsCommon/enum/confirmDialogTypesEnum"),s=e("attributes/enum/permissionMasksEnum"),r=e("attributes/factory/rowTemplatesFactory"),d="~secure~",a="28px",l="100%",h=n.extend({tagName:"div",className:"table-row",ui:{passwordInput:"input[type='password']"},events:t.extend({},n.prototype.events,{"click .edit":"toggleActive","click .cancel":"cancel","click .delete":"_onDeleteClick","click .ok":"runValidation","click @ui.passwordInput":"toggleValue","blur @ui.passwordInput":"toggleValue"}),modelEvents:{change:"_onModelChange"},computeds:t.extend(n.prototype.computeds,{readOnly:{deps:["inherited","permissionMask"],get:function(e,t){var i=t===s.READ_ONLY;return i||e&&i}},disableRemove:{deps:["inherited","permissionMask"],get:function(e,t){return e||t===s.READ_ONLY}}}),initialize:function(){this.editMode=!1,this._onViewInitialize&&this._onViewInitialize(),n.prototype.initialize.apply(this,arguments)},render:function(){return n.prototype.render.apply(this,arguments),this._onViewRender&&this._onViewRender(),this},getTemplate:function(){var e=!this.editMode&&this.model.get("name");return t.template(r({editMode:!e}))},toggleActive:function(){var e=new i.Deferred,t=this;return this.toggleMode().done(function(){t.trigger("active",t.editMode,e)}),e},toggleMode:function(){var e=this,t=new i.Deferred;return this.editMode=!this.editMode,this.editMode?this.render().slideDown({done:function(){t.resolve()}}):this.slideUp({done:function(){e.render().$el.css({height:l}).show(),t.resolve()}}),t},toggleIfModelIsValid:function(){return this.validateModel()?(this.model.setState("confirmedState"),this.model.isNew()&&this.confirmState(),this.modelChanged=null,this.toggleActive()):new i.Deferred},slideDown:function(e){return this.hide().slideDown(e),this},slideUp:function(e,t){return this.$el.animate({height:t||a},e),this},hide:function(){return this.$el.hide()},show:function(){return this.$el.show()},cancel:function(){this.model.set(this.model.getState("confirmedState")),this.toggleActive()},runValidation:function(e){this.validateModel()&&this.triggerConfirmOpening(e)},triggerConfirmOpening:function(e){e=e||{};var n=new i.Deferred,s=this,r=function(){s.permissionConfirmShouldBeShown?s._openPermissionConfirm&&t.bind(s._openPermissionConfirm,s,e)():s.triggerModelValidation(e)};this.model.isNew()?r():this.modelChanged?(this.modelChanged.name?this.trigger("open:confirm",o.NAME_CONFIRM,{dfd:n}):n.resolve(),n.done(function(){s.modelChanged._embedded?r():s.triggerModelValidation(e)})):this.toggleActive()},triggerModelValidation:function(e){this.model.trimAttrs(["name","value","description"]),this.trigger("validate",e)},validateModel:function(){return this.model.isValid(!0)},confirmState:function(e){this.stateConfirmed=e||!0},isStateConfirmed:function(){return this.stateConfirmed},isInherited:function(){return this.model.getState("originalState").inherited},getChangedProperties:function(e){return this.modelChanged?e?this.modelChanged[e]:this.modelChanged:void 0},toggleValue:function(e){if(this.editMode){var t=i(e.target),n=t.val(),o=n===d,s=i(e.relatedTarget).hasClass("ok"),r="click"===e.type;n&&(r&&o&&(t.val(""),this.model.resetField("value")),r||s||t.val(d))}},_onDeleteClick:function(){this.trigger("open:confirm",o.DELETE_CONFIRM,this,this.model)},_onSaveSuccess:function(){this.modelChanged=null,this.model.setId(),this.model.get("secure")&&this.model.resetField("value"),this.model.setState(),this.model.setState("confirmedState")},_onModelChange:function(e){this.modelChanged=this.modelChanged||{};var i,n=e.changedAttributes(),o=this.model.getState(),s=this.isInherited(),r=e.isNew();t.each(n,function(e,i){if("inherited"!==i){var n=o[i],s=t.isObject(e)?t.isEqual(n,e):n===e;s?delete this.modelChanged[i]:this.modelChanged[i]=e}},this),i=!t.isEmpty(this.modelChanged),s&&e.set("inherited",!i),!this.editMode&&n.secure&&e.setState("confirmedState"),this.trigger("changed",i||r),this.model.validate(this.modelChanged)}});return h});