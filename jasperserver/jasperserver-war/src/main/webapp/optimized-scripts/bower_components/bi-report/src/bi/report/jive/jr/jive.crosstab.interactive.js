define(["jquery.ui","text!jr.jive.crosstab.templates.tmpl","text!jr.jive.i18n.tmpl"],function(t,e,o){var s=JSON.parse(o),i=function(t){return s.hasOwnProperty(t)?s[t]:t},a={initialized:!1,selected:null,init:function(e){var o=this;this.reportId=e.id,this.scaleFactor=1,t.each(e.components.crosstab,function(){o.initCrosstab(this,e)})},scale:function(t){this.scaleFactor=t,this.selected&&(this.selected.header.hasClass("jrxtcolheader")?this.selectDataColumn(this.selected.crosstab,this.selected.cell):this.selectRowGroup(this.selected.crosstab,this.selected.cell))},createComponents:function(){var o=this;this.$jiveComponents=t("<div/>",{id:"jivext_components"}),t("body").append(this.$jiveComponents),this.$jiveComponents.empty(),this.$jiveComponents.append(e),o.getReportContainer(this.reportId).on("click touchend",function(){o.hide()})},actions:{sortAscending:{icon:"sortAscIcon",title:i("column.sortasc.title"),fn:"sort",arg:"ASCENDING"},sortDescnding:{icon:"sortDescIcon",title:i("column.sortdesc.title"),fn:"sort",arg:"DESCENDING"}},initCrosstab:function(t){this.crosstabElement=a.getReportContainer(a.reportId),this.crosstab=t,this.crosstabElement.on("click touchend","td.jrxtcolheader[data-jrxtid='"+t.getFragmentId()+"']",this._onClick),this.crosstabElement.on("click touchend","td.jrxtdatacell[data-jrxtid='"+t.getFragmentId()+"']",this._onClick),this.crosstabElement.on("click touchend","td.jrxtrowheader[data-jrxtid='"+t.getFragmentId()+"']",this._onClick)},_onClick:function(e){if(!t(e.target).parent().is("a")){var o=t(e.currentTarget).hasClass("jrxtrowheader")?"RowGroup":"DataColumn";return a.reportId=t(e.delegateTarget).closest(".visualizejs._jr_report_container_").attr("data-reportId"),!a.$jiveComponents&&a.createComponents(),a["select"+o](a.crosstab,t(this)),!1}},selectDataColumn:function(e,o){var s=o.data("jrxtcolidx"),i=o.data("jrxtid"),n=o.parents("table:first"),r=t("td.jrxtcolheader[data-jrxtid='"+i+"'][data-jrxtcolidx='"+s+"']:first",n),l=t("td.jrxtdatacell[data-jrxtid='"+i+"'][data-jrxtcolidx='"+s+"']:last",n),h=l.offset().left+l.outerWidth()-r.offset().left,c=l.offset().top+l.outerHeight()-r.offset().top;a.selected={crosstab:e,header:r,cell:o},a.overlay.show({w:h,h:c,zoom:this.scaleFactor});var s=r.data("jrxtcolidx"),d=e.isDataColumnSortable(s);a.foobar.show(d)},selectRowGroup:function(e,o){var s=o.data("jrxtcolidx"),i=o.data("jrxtid"),n=t("td.jrxtrowheader[data-jrxtid='"+i+"'][data-jrxtcolidx='"+s+"']",o.parents("table:first")),r=t(n[0]),l=t(n[n.length-1]),h=l.offset().left+l.outerWidth()-r.offset().left,c=l.offset().top+l.outerHeight()-r.offset().top;a.selected={crosstab:e,header:r,cell:o},a.overlay.show({w:h,h:c,zoom:this.scaleFactor}),a.foobar.show(!0)},overlay:{jo:null,show:function(e){var o=!this.jo||!this.jo.length;o&&(this.jo=t("#jivext_overlay")),this.jo.css({width:e.w*(e.zoom?e.zoom:1),height:e.h}),this.jo.appendTo(a.getReportContainer(a.reportId)).show(),this.jo.position({of:a.selected.header,my:"left top",at:"left top",collision:"none"}),o&&this.jo.position({of:a.selected.header,my:"left top",at:"left top",collision:"none"})},remove:function(){this.jo.remove(),this.jo=null}},foobar:{jo:null,initialWidth:0,cache:null,setElement:function(){this.jo=t("#jivext_foobar"),this.jo.on("mousedown touchstart","button",function(){var e=t(this);return!e.hasClass("disabled")&&e.addClass("pressed"),!1}),this.jo.on("mouseup touchend","button",function(){var e=t(this);e.removeClass("pressed");var o=e.attr("fn");return o&&!e.hasClass("disabled")&&a[o](a.actions[e.attr("actionkey")].arg),!1}),this.jo.on("mouseover","button",function(){var e=t(this);!e.hasClass("disabled")&&e.addClass("over")}),this.jo.on("mouseout","button",function(){t(this).removeClass("over pressed")}),this.cache=null,this.menus={}},show:function(t){var e=!this.jo||!this.jo.length;e&&this.setElement(),this.render(a.actions),this.jo.find("button").removeClass("over pressed disabled"),t||this.jo.find("button").addClass("disabled"),this.jo.appendTo(a.getReportContainer(a.reportId)).show(),e&&(this.initialWidth=this.jo.width());var o=this.jo.outerHeight()-1;this.jo.position({of:a.selected.header,my:"left top-"+o,at:"left top"}),e&&this.jo.position({of:a.selected.header,my:"left top-"+o,at:"left top"}),this.jo.width()>=this.initialWidth||this.jo.width(this.initialWidth)},render:function(e){var o=this,s=['<button class="jivext_foobar_button" title="',,'" actionkey="',,'" ',,'><span class="wrap"><span class="icon ',,'"></span></span></button>'];if(!o.cache){o.cache="";t.each(e,function(t,e){s[1]=e.title,s[3]=t,s[5]=e.fn?'fn="'+e.fn+'"':e.actions?'menu="'+t+'"':"",s[7]=e.icon,o.cache+=s.join("")}),o.jo.empty(),o.jo.html(o.cache)}},reset:function(){this.cache=null,this.menus={}},remove:function(){this.reset(),this.jo.off().remove(),this.jo=null}},getReportContainer:function(){return t("table.jrPage").closest("div.body")},hide:function(){a.overlay.jo&&a.overlay.jo.appendTo(this.$jiveComponents).hide(),a.foobar.jo&&a.foobar.jo.appendTo(this.$jiveComponents).hide()},sort:function(t){if(this.hide(),this.selected.header.hasClass("jrxtcolheader")){var e=this.selected.header.data("jrxtcolidx"),o=t;o==this.selected.crosstab.getColumnOrder(e)&&(o="NONE"),this.selected.crosstab.sortByDataColumn(e,o)}else if(this.selected.header.hasClass("jrxtrowheader")){var s=this.selected.header.data("jrxtcolidx"),o=t;o==this.selected.crosstab.config.rowGroups[s].order&&(o="NONE"),this.selected.crosstab.sortRowGroup(s,o)}},remove:function(e){var o=t("[data-reportId = '"+e.id+"']");this.$jiveComponents=this.$jiveComponents||t("<div/>"),(o.find(this.overlay.jo).length||this.$jiveComponents.find(this.overlay.jo).length)&&(this.overlay.remove(),this.foobar.remove()),o.off("click touchend").find("table.jrPage").off("click touchend"),this.$jiveComponents.remove(),this.$jiveComponents=null}};return a});