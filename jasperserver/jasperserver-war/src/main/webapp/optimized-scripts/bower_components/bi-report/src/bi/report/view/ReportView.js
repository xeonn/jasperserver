define(["require","underscore","backbone","../jive/enum/jiveTypes","../enum/reportCreators","../jive/view/JiveComponentCollectionView","../enum/reportOutputFormats","jquery","common/util/browserDetection","../enum/reportEvents","../enum/scaleStrategies","common/util/domUtil","domReady","common/component/overlay/LoadingOverlay","common/component/frame/LocalFrameView"],function(e){function t(e,t,i,o,r){var n;if(e===p.WIDTH)n=o/t;else if(e===p.HEIGHT)n=r/i;else{var a=o/t,s=r/i;n=r>a*i?a:s}return n}function i(e,t){var i=e.model.components.getLinks(),n=e.linkOptions();n.beforeRender&&i.length&&n.beforeRender(r.map(i,function(e){return{element:t.find("[data-id='"+e.id+"']")[0],data:e}})),n.events&&i.length&&(e.events=r.reduce(r.keys(n.events),function(t,r){return t[r+" ._jrHyperLink"]=o(i,e.stateModel.get("linkOptions").events[r]),t},{}),e.delegateEvents())}function o(e,t){return function(i){t.call(this,i,r.findWhere(e,{id:i.currentTarget.getAttribute("data-id")}))}}var r=e("underscore"),n=e("backbone"),a=e("../jive/enum/jiveTypes"),s=e("../enum/reportCreators"),l=e("../jive/view/JiveComponentCollectionView"),c=e("../enum/reportOutputFormats"),h=e("jquery"),d=e("common/util/browserDetection"),m=e("../enum/reportEvents"),p=e("../enum/scaleStrategies"),u=e("common/util/domUtil"),v=e("domReady"),f=e("common/component/overlay/LoadingOverlay"),g=e("common/component/frame/LocalFrameView");return n.View.extend({el:"<div style='height: 100%;'></div>",$reportContainer:!1,$jrTables:!1,savedContainersOverflow:!1,reportIsEmpty:!1,initialize:function(e){this.stateModel=e.stateModel,this.jiveComponentCollectionView=new l({collection:this.collection,stateModel:e.stateModel}),this.$el.css("position","relative"),this._afterResizeFunc=r.throttle(r.bind(this.applyScale,this),500),h(window).on("resize",this._afterResizeFunc)},linkOptions:function(){return this.stateModel.get("linkOptions")},remove:function(){return h(window).off("resize",this._afterResizeFunc),this._setLocalFrameSize&&(h(window).off("resize",this._setLocalFrameSize),this._setLocalFrameSize=!1),this.jiveComponentCollectionView.remove(),n.View.prototype.remove.call(this)},setContainer:function(e){var t=h(e),i=this;return t.length?(t.empty(),this.$jrTables=!1,this.$reportContainer=t,this.containerAttachedToDOM=new h.Deferred,v(function(){i.stateModel.get("isolateDom")?(i.localFrameView=new g,i.$reportContainer.html(i.localFrameView.$el)):(i.$reportContainer.html(i.$el),i.showOverlay()),i.containerAttachedToDOM.resolve()}),!0):!1},render:function(){var e=this,t=new h.Deferred;return this.containerAttachedToDOM.done(function(){if(e.stateModel.get("isolateDom"))e.renderIsolatedDom(t);else{if(e.renderReport(),this.reportIsEmpty)return void t.resolve();e.showOverlay(),e.renderJive().done(function(){t.resolve()})}}),t},renderIsolatedDom:function(e){var t=this,i=function(){return t.localFrameView.$el.width("100%"),t.isElasticChart()&&(t._setLocalFrameSize=r.throttle(function(){var e=t.$reportContainer.height();t.localFrameView.$el.height(e||400)},100),t._setLocalFrameSize(),h(window).resize(t._setLocalFrameSize)),t.renderReport(),t.reportIsEmpty?void e.resolve():void t.renderJive().done(function(){e.resolve()})};this.localFrameView.add(this.$el,i)},renderReport:function(){var e=this.model.getExport(c.HTML).getHTMLOutput(),t=this.isElasticChart(),o=h(e);if(e){this.reportIsEmpty=!1,this.stateModel.get("linkOptions")&&i(this,o),t&&(o=o.find(".highcharts_parent_container").clone().css({margin:"0 auto",height:"100%"}),o=h("<div></div>").append(o).append("<table cellpadding='0' cellspacing='0' class='jrPage'></table>").html()),this.$el.html(o),this.trigger(m.BEFORE_RENDER,this.$el[0]);var n=this.$reportContainer;this.loadingOverlay&&this.loadingOverlay.showScrollBarOnContainer(),this.stateModel.get("isolateDom")&&(n=this.localFrameView.$frameBody),this.$jrTables=n.find(t?"._jr_report_container_":"._jr_report_container_ > table"),r.isUndefined(this.model.execution.get("scale"))&&this.model.execution.set("scale",this.isElasticChart()?p.CONTAINER:1),this.applyScale()}else this.reportIsEmpty=!0,this.$el.empty();return this},renderJive:function(){var e=this,t=this.jiveComponentCollectionView.render(this.$el);return t.then(function(){e.hideOverlay()}),t},showOverlay:function(){var e=this,t=function(){if(e.stateModel.get("loadingOverlay")!==!1&&e.$reportContainer){var t=e.$el;e.stateModel.get("isolateDom")&&(t=e.localFrameView.$frameBody),e.loadingOverlay?(e.loadingOverlay.setExternalContainer(e.$reportContainer),e.loadingOverlay.setBiComponentContainer(t),e.loadingOverlay.setBiComponent(e.$jrTables),e.loadingOverlay.setScaleFactor(e.scaleFactor)):e.loadingOverlay=new f({propertiesModel:e.stateModel,scaleFactor:e.scaleFactor,externalContainer:e.$reportContainer,biComponentContainer:t,biComponent:e.$jrTables}),e.loadingOverlay.show()}};this.stateModel.get("isolateDom")?this.localFrameView.frameLoaded.done(t):t()},hideOverlay:function(){this.loadingOverlay&&this.loadingOverlay.hide()},applyScale:function(){if(this.$jrTables){var e=this.stateModel.get("scale");if(r.isUndefined(e)&&(e=this.isElasticChart()?p.CONTAINER:1),r.contains(r.values(p),e))return void this._resizeTo(e);var t=/^\d+%$/.test(e);e=parseFloat(e.toString().replace(",",".")),r.isNaN(e)||(t&&(e/=100),this._applyScaleTransform(e))}},_applyScaleTransform:function(e){this.scaleFactor=e,this.loadingOverlay&&this.loadingOverlay.applyScale(e);var t=this._getCssRulesForScalingFactor(e);this.$jrTables.css(t),r.invoke(this.jiveComponentCollectionView.scalableSubviews(),"scale",e),this.stateModel.get("isolateDom")&&(this.localFrameView.$el.width()<this.$jrTables.width()*e&&this.localFrameView.$el.width(this.$jrTables.width()*e),this.localFrameView.$el.height(this.$jrTables.height()*e-5))},_getCssRulesForScalingFactor:function(e){var t="scale("+e+")",i="top left",o={"-webkit-transform":t,"-moz-transform":t,"-ms-transform":t,"-o-transform":t,transform:t,"-webkit-transform-origin":i,"-moz-transform-origin":i,"-ms-transform-origin":i,"-o-transform-origin":i,"transform-origin":i};return d.isIE8()&&(o.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+e+", M12=0, M21=0, M22="+e+", SizingMethod='auto expand')"),o},_resizeTo:function(e){if(this.isElasticChart()){this._applyScaleTransform(1),this._autoScaleFontsEnabled()&&this._setAutoScaleFonts();var i=this.$jrTables.parents();r.invoke(this.jiveComponentCollectionView.sizableSubviews(),"setSize",i.width(),i.height())}else{var o=this.$jrTables.width(),n=this.$jrTables.height(),a=this.$reportContainer.width(),s=this.$reportContainer.height()||400,l=t(e,o,n,a,s);if(u.isScrollable(this.$reportContainer[0])){var c=u.getScrollbarWidth();(e===p.CONTAINER||e===p.WIDTH)&&l*n>s&&(a-=c+1,l=t(e,o,n,a,s)),(e===p.CONTAINER||e===p.HEIGHT)&&l*o>a&&(s-=c+1,l=t(e,o,n,a,s))}this._applyScaleTransform(l)}},isElasticChart:function(){return this.collection.some(function(e){return s.AD_HOC_DESIGNER===e.get("creator")&&a.CHART===e.get("type")})},_autoScaleFontsEnabled:function(){return this.collection.some(function(e){return e.get("hcinstancedata").services[0].data.chartState.autoScaleFonts})},_setAutoScaleFonts:function(){var e=parseInt(this.$jrTables.css("font-size")),t=this.$jrTables.width(),i=t>600?1:(Math.floor(t/100)+4)/10,o=Math.round(e*i);e!==o&&this.$jrTables.find(".highcharts_parent_container").css("font-size",o)}})});