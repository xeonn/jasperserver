define(["require","backbone","underscore","../model/BaseComponentModel","../model/ColumnComponentModel","../model/TableComponentModel","../model/CrosstabComponentModel","../model/ChartComponentModel","../model/FusionComponentModel","../model/GooglemapComponentModel","../model/WebfontsComponentModel","../model/HyperlinksComponentModel","../enum/jiveTypes","logger"],function(e){function t(e){var t=1;if(e)if(r.isNumber(e))t=e;else try{t=parseInt(C.exec(e)[1],10)}catch(o){}return t--,t}function o(e,t){var o=r.clone(t);if(t.events){var n={};r.each(r.keys(t.events),function(o){n[o]=function(e,t){return function(o,n){e.call(this,n,r.findWhere(t.getLinks(),{id:o}))}}(t.events[o],e)}),o.events=n}return o}var n=e("backbone"),r=e("underscore"),i=e("../model/BaseComponentModel"),s=e("../model/ColumnComponentModel"),a=e("../model/TableComponentModel"),l=e("../model/CrosstabComponentModel"),p=e("../model/ChartComponentModel"),c=e("../model/FusionComponentModel"),d=e("../model/GooglemapComponentModel"),u=e("../model/WebfontsComponentModel"),m=e("../model/HyperlinksComponentModel"),h=e("../enum/jiveTypes"),f=e("logger").register("ReportComponentCollection"),C=new RegExp("^(\\d+)(\\-\\d+)?$");return n.Collection.extend({initialize:function(e,t){var n=this;this._parts=[],this._root=null,this.stateModel=t.stateModel,this.report=t.report,this.stateModel.get("linkOptions")&&(this.linkOptions=o(this,this.stateModel.get("linkOptions"))),this.listenTo(this.stateModel,"change:linkOptions",function(e,t){n.linkOptions=o(n,t)}),this.on("change add reset remove",function(){r.each(h,function(e){n[e]=[]}),n.forEach(function(e){n[e.get("type")]&&n[e.get("type")].push(e)})})},registerPart:function(e){var t=this;e&&(e.get("parentId")?t._root?t._root.registerPart(e):t._parts.push(e):(t._root=e,r.each(this._parts,function(e){t._root.registerPart(e)})))},model:function(e,t){var o,n=e.type;return t||(t={}),r.extend(t,{parent:t.collection.report,linkOptions:t.collection.linkOptions}),o=h.TABLE==n?new a(e,t):h.CROSSTAB==n?new l(e,t):h.COLUMN==n?new s(e,t):h.CHART==n?new p(e,t):h.GOOGLEMAP==n?new d(e,t):h.FUSION_CHART==n||h.FUSION_MAP==n||h.FUSION_WIDGET==n?new c(e,t):h.WEBFONTS==n?new u(e,t):h.HYPERLINKS==n?new m(e,t):new i(e,t),t.collection.registerPart(o),o},url:function(){var e=this.report.contextPath;return"/"!==e[e.length-1]&&(e+="/"),e+="getReportComponents.html"},fetch:function(){if(!this.report.has("requestId"))throw new Error("You must run report first before fetching components.");return n.Collection.prototype.fetch.call(this,{type:"POST",reset:!0,headers:{Accept:"application/json","x-jrs-base-url":this.report.contextPath},data:{jasperPrintName:this.report.get("requestId"),pageIndex:t(this.report.execution.get("pages"))}})},add:function(e,t){return this.stateModel.get("isolateDom")&&r.each(e,function(e,t,o){-1!==e.type.indexOf("fusion")&&(f.info("Fusion components usage deprecated when isolateDom option enabled for report"),delete o[t])}),n.Collection.prototype.add.call(this,e,t)},parse:function(e){return r.values(e)},getComponents:function(){var e=this.reduce(function(e,t){if(t.toReportComponentObject){var o=t.toReportComponentObject();r.isArray(o)?e=e.concat(o):e.push(o)}return e},[]);return r.forEach(e,function(e){void 0===e.name&&delete e.name}),e},getLinks:function(){return this.reduce(function(e,t){return t.get("type")===h.HYPERLINKS?e.concat(t.get("hyperlinks")):e},[])},updateComponents:function(e){var t=this,o=[],i=new n.Collection(this.map(function(e){var t=new n.Model(e.attributes);return r.extend(t,{updateFromReportComponentObject:e.updateFromReportComponentObject,actions:e.actions,parent:e.parent,headingFormat:e.headingFormat,detailsRowFormat:e.detailsRowFormat,conditions:e.conditions}),e.attachEvents&&e.attachEvents.call(t),t}));return i.forEach(function(e){r.each(e.actions,function(n,r){t.listenToOnce(e,r,function(e,t,n){o.push(e.actions[r].call(e,n))})})}),r.each(e,function(e){var t=i.get(e.id.split("/")[0]);t&&t.updateFromReportComponentObject(e)}),o}})});