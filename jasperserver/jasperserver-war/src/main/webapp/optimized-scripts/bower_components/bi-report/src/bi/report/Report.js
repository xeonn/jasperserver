define(["require","exports","module","underscore","jquery","json3","backbone","logger","common/bi/component/util/biComponentUtil","common/bi/component/BiComponent","common/bi/error/enum/biComponentErrorCodes","./error/biComponentErrorFactoryReportProxy","./model/ReportModel","./ReportController","./model/ReportExportModel","./model/ReportPropertiesModel","./view/ReportView","./enum/reportOutputFormats","./jive/enum/jiveTypes","./jive/enum/interactiveComponentTypes","./enum/reportEvents","text!./schema/Report.json","text!./schema/ReportExport.json","text!./schema/Chart.json","text!./schema/CrosstabDataColumn.json","text!./schema/CrosstabRowGroup.json","text!./schema/TableColumn.json"],function(e,t,r){function o(e){var t=null;return e&&E.keys(e).length&&(t={reportParameter:E.map(e,function(e,t){return{name:t,value:e}})}),t}function n(e,t,r,n,i){var a,s,c,p=this.validate(),l=this;if(p)return c=T.validationError(p),f.error(c.toString()),void e.reject(c);if(t.properties.isolateDom&&(E.isUndefined(t.properties.defaultJiveUi)||t.properties.defaultJiveUi.enabled!==!1))return c=T.genericError(S.UNSUPPORTED_CONFIGURATION_ERROR,"Default JIVE UI should be disabled when isolateDom option is true"),f.error(c.toString()),void e.reject(c);if(t.properties.container){var d=R(t.properties.container);if(!d.length||"1"!=d[0].nodeType)return c=T.containerNotFoundError(t.properties.container),f.error(c.toString()),void e.reject(c);r.view.setContainer(d)}r.model.set("reportURI",t.properties.resource),r.model.contextPath=t.properties.server,C.createReadOnlyProperty(this,"server",t,!0,i),C.createReadOnlyProperty(this,"resource",t,!0,i),s=r.model.execution.get("parameters"),a=r.model.execution.get("pages"),E.extend(r.model.getExport(_.HTML).get("options"),{pages:t.properties.pages}),r.model.execution.set({pages:t.properties.pages,scale:t.properties.scale,parameters:o(t.properties.params)});var u=r.model.execution.changedAttributes(),m=u&&"parameters"in u,g=u&&"pages"in u,v=function(){t.properties.container?r.renderReport().always(function(){e.resolve(l.data())}):e.resolve(l.data())},A=function(){t.data.totalPages=r.model.get("totalPages"),t.data.components=r.components.getComponents(),t.data.links=r.components.getLinks(),v()},O=function(o){if(r.view.hideOverlay(),m&&r.model.execution.set({parameters:s},{silent:!0}),g&&(r.model.execution.set({pages:a},{silent:!0}),t.properties.pages=a),o.errorDescriptor&&o.errorDescriptor.errorCode){var n=T.genericError(o.errorDescriptor.errorCode,o.errorDescriptor.message,o.errorDescriptor.parameters);f.error(n.toString()),e.reject(n)}else if("export"===o.source||"execution"===o.source){var n=T.reportStatus(o);f.error(E.include([S.REPORT_EXECUTION_FAILED,S.REPORT_EXECUTION_CANCELLED,S.REPORT_EXPORT_FAILED,S.REPORT_EXPORT_CANCELLED],n)?n.toString():"Report "+o.source+("export"===o.source?" to format '"+o.format+"'":"")+" "+o.status+": "+n.toString()),e.reject(n)}else{var n=T.requestError(o);f.error(n.toString()),e.reject(n)}};r.view.showOverlay(),r.model.isNew()?r.executeReport(n).then(A,O):m||n?r.applyReportParameters(n).then(A,O):g?r.fetchReportHtmlExportAndJiveComponents().then(A,O):v()}function i(e,t,r){if(r.view.setContainer(t.properties.container)===!1){var o=T.containerNotFoundError(t.properties.container);return f.error(o.toString()),void e.reject(o)}r.renderReport(t.properties.container).done(function(){e.resolve(r.view.$el[0])})}function a(e,t){t.cancelReportExecution().done(e.resolve).fail(function(t){var r=T.requestError(t);f.error(r.toString()),e.reject(r)})}function s(e,t){t.undoReportAction().done(e.resolve).fail(function(t){var r=T.requestError(t);f.error(r.toString()),e.reject(r)})}function c(e,t){t.undoAllReportAction().done(e.resolve).fail(function(t){var r=T.requestError(t);f.error(r.toString()),e.reject(r)})}function p(e,t){t.redoReportAction().done(e.resolve).fail(function(t){var r=T.requestError(t);f.error(r.toString()),e.reject(r)})}function l(e,t,r){t.destroy().done(function(){r.set("_destroyed",!0),e.resolve()}).fail(function(t){var r=T.requestError(t);f.error(r.toString()),e.reject(r)})}function d(e,t){return function(r,o,n,i){var a,s,c;if(t.get("_destroyed"))c=T.alreadyDestroyedError(),f.error(c.toString()),a=(new R.Deferred).reject(c);else try{s=C.validateObject(j,r),s?(a=new R.Deferred,c=T.validationError(s),f.error(c.toString()),a.reject(c)):a=e.exportReport(r)}catch(p){a=new R.Deferred,c=T.javaScriptException(p),f.error(c.toString()),a.reject(c)}return a.done(o).fail(n).always(i),a}}function u(e,t){return function(){var r,o,n,i,a,s,c=new R.Deferred;if(t.get("_destroyed"))r=T.alreadyDestroyedError(),f.error(r.toString()),c.reject(r);else try{E.isString(arguments[0])?(o=arguments[0],n=arguments[1],i=arguments[2],a=arguments[3],s=arguments[4]):(n=arguments[0],o=n.id,i=arguments[1],a=arguments[2],s=arguments[3]),i&&E.isFunction(i)&&c.done(i),a&&E.isFunction(a)&&c.fail(a),s&&E.isFunction(s)&&c.always(s);var p=E.findWhere(e.components.getComponents(),{name:o})||E.findWhere(e.components.getComponents(),{id:o});if(!p)throw new Error("Component with such name or id '"+o+"' was not found");var l=E.extend(p,n),d=I[l.componentType];if(!d)throw new Error("Cannot validate component - unknown component type '"+l.componentType+"'");var u=C.validateObject(d,p);if(u)r=T.validationError(u),f.error(r.toString()),c.reject(r);else{var m=e.components.updateComponents([l]);m&&E.isArray(m)&&(m=E.compact(m)),m&&E.isArray(m)&&m.length?e.runReportAction(m).then(function(){c.resolve(E.findWhere(e.components.getComponents(),{name:o}))},function(e){var t;"export"===e.source||"execution"===e.source?(t=T.reportStatus(e),f.error(E.include([S.REPORT_EXECUTION_FAILED,S.REPORT_EXECUTION_CANCELLED,S.REPORT_EXPORT_FAILED,S.REPORT_EXPORT_CANCELLED],t)?t.toString():"Report "+e.source+("export"===e.source?" to format '"+e.format+"'":"")+" "+e.status+": "+t.toString()),c.reject(t)):(t=T.requestError(e),f.error(t.toString()),c.reject(t))}):c.resolve(E.findWhere(e.components.getComponents(),{name:o}))}}catch(g){r=T.javaScriptException(g),f.error(r.toString()),c.reject(T.javaScriptException(g))}return c}}function m(e,t,r,o){return function(n){if(o.get("_destroyed"))throw T.alreadyDestroyedError();var i=this;return n&&E.isObject(n)&&E.keys(n).length?(E.each(e.events,function(e,o){E.isFunction(e)&&(o===U.CHANGE_TOTAL_PAGES?t.stopListening(r.model,"change:totalPages",e):o===U.CAN_REDO||o===U.CAN_UNDO?t.stopListening(r.stateStack,"change:position",e):o===U.REPORT_COMPLETED?t.stopListening(r,x.REPORT_COMPLETED,e):o===U.PAGE_FINAL?t.stopListening(r,x.PAGE_FINAL,e):o===U.BEFORE_RENDER&&t.stopListening(r.view,x.BEFORE_RENDER,e))}),E.each(n,function(t,o){E.isFunction(t)&&(o===U.CHANGE_TOTAL_PAGES?e.events[o]=function(){t.call(i,r.model.get("totalPages"))}:o===U.CAN_UNDO?e.events[o]=function(){t.call(i,r.stateStack.get("canUndo"))}:o===U.CAN_REDO?e.events[o]=function(){t.call(i,r.stateStack.get("canRedo"))}:o===U.PAGE_FINAL?e.events[o]=function(e){t.call(i,e)}:o===U.REPORT_COMPLETED?e.events[o]=function(e,r){if(r)try{r="export"===r.source||"execution"===r.source?T.reportStatus(r):T.requestError(r)}catch(o){r=T.javaScriptException(o)}t.call(i,e,r)}:o===U.BEFORE_RENDER&&(e.events[o]=E.bind(t,i)))}),E.each(e.events,function(e,o){E.isFunction(e)&&(o===U.CHANGE_TOTAL_PAGES?t.listenTo(r.model,"change:totalPages",e):o===U.CAN_REDO?t.listenTo(r.stateStack,"change:canRedo",e):o===U.CAN_UNDO?t.listenTo(r.stateStack,"change:canUndo",e):o===U.PAGE_FINAL?t.listenTo(r,x.PAGE_FINAL,e):o===U.REPORT_COMPLETED?t.listenTo(r,x.REPORT_COMPLETED,e):o===U.BEFORE_RENDER&&t.listenTo(r.view,x.BEFORE_RENDER,e))}),i):i}}var E=e("underscore"),R=e("jquery"),g=e("json3"),v=e("backbone"),f=e("logger").register(r),C=e("common/bi/component/util/biComponentUtil"),A=e("common/bi/component/BiComponent"),S=e("common/bi/error/enum/biComponentErrorCodes"),T=e("./error/biComponentErrorFactoryReportProxy"),O=(e("./model/ReportModel"),e("./ReportController")),P=(e("./model/ReportExportModel"),e("./model/ReportPropertiesModel")),_=(e("./view/ReportView"),e("./enum/reportOutputFormats")),h=(e("./jive/enum/jiveTypes"),e("./jive/enum/interactiveComponentTypes")),x=e("./enum/reportEvents"),D=g.parse(e("text!./schema/Report.json")),j=g.parse(e("text!./schema/ReportExport.json")),y=g.parse(e("text!./schema/Chart.json")),L=g.parse(e("text!./schema/CrosstabDataColumn.json")),N=g.parse(e("text!./schema/CrosstabRowGroup.json")),b=g.parse(e("text!./schema/TableColumn.json")),w=E.keys(D.properties),F=["properties"],k=["data"],U={CHANGE_TOTAL_PAGES:"changeTotalPages",CAN_UNDO:"canUndo",CAN_REDO:"canRedo",BEFORE_RENDER:"beforeRender",PAGE_FINAL:"pageFinal",REPORT_COMPLETED:"reportCompleted"},I={};I[h.CHART]=y,I[h.CROSSTAB_COLUMN]=L,I[h.CROSSTAB_ROW]=N,I[h.TABLE_COLUMN]=b;var M=function(e){e||(e={});var t=e.events,r={properties:E.extend({pages:1},e),data:{totalPages:void 0,components:[],links:[]},events:{}};delete r.properties.events;var o=new P(e||{});C.createInstancePropertiesAndFields(this,r,w,F,k,o);var R=new O(o),g=E.extend({},v.Events);R.view.$el.addClass("visualizejs _jr_report_container_"),g.listenTo(R.model,"change:totalPages",function(){r.data.totalPages=R.model.get("totalPages")}),g.listenTo(R.components,"change add reset remove",function(){r.data.components=R.components.getComponents(),r.data.links=R.components.getLinks()}),g.listenTo(R,x.AFTER_REPORT_EXECUTION,function(){r.properties.pages=1}),E.extend(this,{validate:C.createValidateAction(r,D,o),run:C.createDeferredAction(n,o,r,R,!1,o),refresh:C.createDeferredAction(n,o,r,R,!0,o),render:C.createDeferredAction(i,o,r,R),cancel:C.createDeferredAction(a,o,R),undo:C.createDeferredAction(s,o,R),undoAll:C.createDeferredAction(c,o,R),redo:C.createDeferredAction(p,o,R),destroy:C.createDeferredAction(l,o,R,o),"export":d(R,o),updateComponent:u(R,o),events:m(r,g,R,o)}),this.events(t)};return M.prototype=new A,E.extend(M,{exportFormats:["pdf","xlsx","xls","rtf","csv","xml","odt","ods","docx","pptx"],chart:{componentTypes:["chart"],types:["Bar","Column","Line","Area","Spline","AreaSpline","StackedBar","StackedColumn","StackedLine","StackedArea","StackedSpline","StackedAreaSpline","StackedPercentBar","StackedPercentColumn","StackedPercentLine","StackedPercentArea","StackedPercentSpline","StackedPercentAreaSpline","Pie","DualLevelPie","TimeSeriesLine","TimeSeriesArea","TimeSeriesSpline","TimeSeriesAreaSpline","ColumnLine","ColumnSpline","StackedColumnLine","StackedColumnSpline","MultiAxisLine","MultiAxisSpline","MultiAxisColumn","Scatter","Bubble","SpiderColumn","SpiderLine","SpiderArea","HeatMap","TimeSeriesHeatMap"]},table:{componentTypes:["tableColumn"],column:{types:["numeric","boolean","datetime","string","time"]}},crosstab:{componentTypes:["crosstabDataColumn","crosstabRowGroup"]}}),M});