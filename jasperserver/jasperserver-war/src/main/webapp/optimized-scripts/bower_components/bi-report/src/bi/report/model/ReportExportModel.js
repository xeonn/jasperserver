define(["require","common/model/BaseModel","backbone","underscore","json3","jquery","./reportStatusTrait","../enum/reportOutputFormats"],function(t){function e(t){var e=u.parseHTML(t);return e=i.filter(e,function(t){var e=u(t),r=e.prop("tagName");return r=r?r:"","table"===r.toLowerCase()}),0==e.length?!1:e}var r=t("common/model/BaseModel"),o=t("backbone"),i=t("underscore"),n=t("json3"),u=t("jquery"),s=t("./reportStatusTrait"),a=t("../enum/reportOutputFormats"),p=1e3,c=r.extend({defaults:function(){return{attachments:void 0,id:void 0,options:void 0,outputResource:void 0,outputFinal:!1,status:void 0}},initialize:function(t,e){e||(e={}),this.report=e.report,r.prototype.initialize.apply(this,arguments)},url:function(){if(i.isUndefined(this.report.get("requestId")))throw new Error("You must execute report before fetching export.");var t=this.report.contextPath;return"/"!==t[t.length-1]&&(t+="/"),t+="rest_v2/reportExecutions/"+this.report.get("requestId")+"/exports"},urlStatus:function(){if(i.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/status"},urlOutput:function(){if(i.isUndefined(this.get("id")))throw new Error("Export ID is not specified");return this.url()+"/"+this.get("id")+"/outputResource"},run:function(t){t||(t={});var e=i.extend(this.report.execution.pick("outputFormat","pages","attachmentsPrefix","allowInlineScripts","markupType","baseUrl"),this.get("options")?i.pick(this.get("options"),"outputFormat","pages","attachmentsPrefix","allowInlineScripts","markupType","baseUrl"):{},t);return r.prototype.fetch.call(this,{url:this.url(),type:"POST",contentType:"application/json",headers:{Accept:"application/json","x-jrs-base-url":this.report.contextPath},data:n.stringify(e)})},fetchOutput:function(){var t=this;return o.ajax({url:this.urlOutput(),type:"GET",headers:{Accept:"text/html, application/json","x-jrs-base-url":this.report.contextPath},dataType:this.get("options").outputFormat}).done(function(e,r,o){var i=e;t.get("options").outputFormat===a.HTML&&(i=e.markup?e.markup:e),t.set({output:i,outputFinal:"true"===o.getResponseHeader("output-final")})})},getHTMLOutput:function(){return e(this.get("output"))},updateStatus:function(){var t=this,e=o.ajax({type:"GET",url:this.urlStatus(),dataType:"json",contentType:"application/json",headers:{Accept:"application/status+json","x-jrs-base-url":this.report.contextPath}}).done(function(e){return t.set({status:e.value,errorDescriptor:e.errorDescriptor})?void t.trigger("sync",t,e):!1}).fail(function(e){t.trigger("error",t,e)});return this.trigger("request",this,e),e},waitForExport:function(){var t=this,e=new u.Deferred,r=function(){t.isCompleted()?e.resolve():setTimeout(function(){t.updateStatus().done(r).fail(e.reject)},p)};return this.updateStatus().done(r).fail(e.reject),e}});return i.extend(c.prototype,s),c});