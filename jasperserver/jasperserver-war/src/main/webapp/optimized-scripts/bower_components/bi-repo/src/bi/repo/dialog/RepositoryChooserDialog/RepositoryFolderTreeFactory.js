define(["require","common/component/tree/Tree","jquery","underscore","json3","common/component/tree/TreeDataLayer","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/ContextMenuTreePlugin","bi/repo/enum/repositoryResourceTypes","text!bi/repo/dialog/RepositoryChooserDialog/template/repositoryFoldersTreeLevelTemplate.htm","bundle!CommonBundle","settings/generalSettings"],function(e){"use strict";function t(e){var t=2;return e.isWritable&&(t=4|t),e.isRemovable&&(t=16|t),e.isAdministrable&&(t=1),t}var o=e("common/component/tree/Tree"),r=e("jquery"),n=e("underscore"),i=e("json3"),s=e("common/component/tree/TreeDataLayer"),l=e("common/component/tree/plugin/TooltipPlugin"),a=(e("common/component/tree/plugin/ContextMenuTreePlugin"),e("bi/repo/enum/repositoryResourceTypes")),u=e("text!bi/repo/dialog/RepositoryChooserDialog/template/repositoryFoldersTreeLevelTemplate.htm"),c=e("bundle!CommonBundle"),p=e("settings/generalSettings"),m={folderTreeProcessor:{processItem:function(e){return e._node=!0,e._readonly=!(1==e.value.permissionMask||4&e.value.permissionMask),e}},filterPublicFolderProcessor:{processItem:function(e){return e.value.uri!==d.settings.publicFolderUri&&e.value.uri!==d.settings.tempFolderUri?e:void 0}},i18n:{processItem:function(e){return e.i18n=c,e}},tenantProcessor:{processItem:function(e){return e._node=!0,e.value.label=e.value.tenantName,e.value.uri=e.value.tenantUri,e}}},d=function(e){var p=o.use(l,{i18n:c,contentTemplate:e.tooltipContentTemplate}).create().instance({additionalCssClasses:"folders",dataUriTemplate:e.contextPath+"/rest_v2/resources?{{= id != '@fakeRoot' ? 'folderUri=' + id : ''}}&recursive=false&type="+a.FOLDER+"&offset={{= offset }}&limit={{= limit }}",levelDataId:"uri",itemsTemplate:u,collapsed:!0,lazyLoad:!0,rootless:!0,selection:{allowed:!0,multiple:!1},customDataLayers:{"/":n.extend(new s({dataUriTemplate:e.contextPath+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1",processors:n.chain(m).omit("filterPublicFolderProcessor","tenantProcessor").values().value(),getDataArray:function(e){e=i.parse(r(e).text());var o=n.find(e.children,function(e){return"/public"===e.uri}),s=[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",permissionMask:t(e.extra),_links:{content:"@fakeContentLink"}}];return o&&s.push({id:"/public",label:o.label,uri:"/public",resourceType:"folder",permissionMask:t(o.extra),_links:{content:"@fakeContentLink"}}),s}}),{accept:"text/html",dataType:"text"})},processors:[m.i18n,m.folderTreeProcessor,m.filterPublicFolderProcessor],getDataArray:function(e,t,o){return e?e[a.RESOURCE_LOOKUP]:[]}});return p._selectTreeNode=function(e,t){if(""!==e){var o=function(){var o=n.bind(function(){var o=e;if("/"===o&&(o="@fakeRoot"),this.select(o),t&&t.length){var r=this.$el,n=this.getLevel(o).$el;if(!n)return;var i=n.offset().top-r.offset().top-t.height()/2+n.height()/2;t.scrollTop(i)}},this);if("/"===e||"/public"===e)o();else{var i=e.replace(/\/$/,""),s=i.substr(0,i.lastIndexOf("/"));s=s||"/";var l=new r.Deferred;this._openPath(s,l,0),l.done(o)}};this.rootLevel.on("ready",n.bind(o,this))}},p._openPath=function(e,t,o){if(!e)return t.resolve();var r,i,s,l=this;return"/"===e?i=["/"]:(i=e.split("/"),i[0]="/"),"/"===i[0]&&"public"===i[1]&&(i=n.union(["/public"],n.rest(i,2))),o=o||0,o===i.length?t.resolve():(r=n.first(i,o+1).join("/"),"/"===r&&(r="@fakeRoot"),r=r.replace(/\/\//g,"/"),s=this.getLevel(r),void(s&&(s.collapsed?(s.once("ready",function(){l._openPath(e,t,o+1)}),s.open()):this._openPath(e,t,o+1))))},p};return d.settings=p,d});