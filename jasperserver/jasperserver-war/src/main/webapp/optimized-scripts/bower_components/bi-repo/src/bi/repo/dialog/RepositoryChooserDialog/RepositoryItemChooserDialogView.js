define(["require","underscore","jquery","json3","common/component/dialog/Dialog","common/component/dialog/AlertDialog","common/component/tree/Tree","common/component/tree/TreeDataLayer","common/component/panel/trait/tabbedPanelTrait","common/component/tree/plugin/SearchPlugin","common/component/tree/plugin/TooltipPlugin","common/component/tree/plugin/InfiniteScrollPlugin","common/component/tree/plugin/NoSearchResultsMessagePlugin","jrs.configs","bi/repo/enum/repositoryResourceTypes","bundle!adhoc_messages","common/util/browserDetection","text!./template/resourceDialogTemplate.htm","text!./template/sidebarTreeLeafTemplate.htm","text!./template/tabPanelButtonTemplate.htm","text!./template/treeTooltipTemplate.htm"],function(e){"use strict";function t(e){switch(e.value.resourceType){case T.REPORT_UNIT:e.cssClass="topic";break;case T.ADHOC_DATA_VIEW:e.cssClass="adhocDataView"}return e}var o=e("underscore"),i=e("jquery"),s=e("json3"),r=e("common/component/dialog/Dialog"),n=e("common/component/dialog/AlertDialog"),a=e("common/component/tree/Tree"),l=e("common/component/tree/TreeDataLayer"),c=e("common/component/panel/trait/tabbedPanelTrait"),u=e("common/component/tree/plugin/SearchPlugin"),h=e("common/component/tree/plugin/TooltipPlugin"),p=e("common/component/tree/plugin/InfiniteScrollPlugin"),m=e("common/component/tree/plugin/NoSearchResultsMessagePlugin"),d=e("jrs.configs").contextPath,T=e("bi/repo/enum/repositoryResourceTypes"),g=e("bundle!adhoc_messages"),f=e("common/util/browserDetection"),_=e("text!./template/resourceDialogTemplate.htm"),b=e("text!./template/sidebarTreeLeafTemplate.htm"),C=e("text!./template/tabPanelButtonTemplate.htm"),D=e("text!./template/treeTooltipTemplate.htm"),y=22,v="list",S=5e3,R=d+"/rest_v2/api/resources?{{= id != '@fakeRoot' ? 'folderUri=' + id : ''}}",O="&offset={{= offset }}&limit={{= limit }}&forceTotalCount=true&forceFullPage=true",L=R+"&recursive=false&containerType="+T.FOLDER+O,w=R+"&recursive=true"+O,E=d+"/flow.html?_flowId=searchFlow&method=getNode&provider=repositoryExplorerTreeFoldersProvider&uri=/&depth=1";return r.extend({constructor:function(e){e||(e={}),this.options=e,this._dfdRenderSerachFormTo=i.Deferred();var n=a.use(p).use(h,{i18n:g,attachTo:this.$el,contentTemplate:D}).create(),d=a.use(m).use(h,{i18n:g,attachTo:this.$el,contentTemplate:D}).use(u,{dfdRenderTo:this._dfdRenderSerachFormTo}).create(),f={treeNodeProcessor:{processItem:function(e){return e._node=o.contains([T.FOLDER],e.value.resourceType),e}},filterPublicFolderProcessor:{processItem:function(e){return"/public"!==e.value.uri?e:void 0}},filterTempFolderProcessor:{processItem:function(e){return-1===e.value.uri.indexOf("/temp")?e:void 0}},filterEmptyFoldersProcessor:{processItem:function(e){return"folder"!==e.value.resourceType||""!==e.value._links.content?e:void 0}},cssClassItemProcessor:{processItem:t}};this.prepareSpecificChooserDialog(),this.resourcesTreeView=n.instance({itemsTemplate:b,listItemHeight:y,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,bufferSize:S,additionalCssClasses:"folders",dataUriTemplate:L,levelDataId:"uri",customDataLayers:{"/":o.extend(new l({dataUriTemplate:E,processors:o.chain(f).omit("filterPublicFolderProcessor").values().value(),getDataArray:function(e){e=s.parse(i(e).text());var t=o.find(e.children,function(e){return"/public"===e.uri}).label;return[{id:"@fakeRoot",label:e.label,uri:"/",resourceType:"folder",_links:{content:"@fakeContentLink"}},{id:"/public",label:t,uri:"/public",resourceType:"folder",_links:{content:"@fakeContentLink"}}]}}),{accept:"text/html",dataType:"text"})},processors:o.values(f),getDataArray:function(e,t,o){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,o){return+o.getResponseHeader("Total-Count")}}),this.resourcesListView=d.instance({rootLevelHeight:o.bind(this.getContentHeight,this),itemsTemplate:b,listItemHeight:y,selection:{allowed:!0,multiple:!1},rootless:!0,collapsed:!0,lazyLoad:!0,dataUriTemplate:w,levelDataId:"uri",cache:{searchKey:"searchString",pageSize:100},processors:[f.cssClassItemProcessor,f.filterTempFolderProcessor],getDataArray:function(e,t,o){return e&&e[T.RESOURCE_LOOKUP]?e[T.RESOURCE_LOOKUP]:[]},getDataSize:function(e,t,o){return+o.getResponseHeader("Total-Count")}}),r.prototype.constructor.call(this,{template:_,modal:!0,resizable:!0,additionalCssClasses:"sourceDialogNew",title:g.ADH_108_DATA_CHOOSER_DIALOG_TITLE,traits:[c],tabHeaderContainerSelector:".tabHeaderContainer",tabContainerClass:"tabContainer control groupBox treeBox",optionTemplate:C,toggleClass:"down",tabs:[{label:g.ADH_108_DATA_CHOOSER_FOLDERS_TAB,action:"tree",content:this.resourcesTreeView,exposeAction:!0,additionalCssClasses:"action square small",i18n:g},{label:g.ADH_108_DATA_CHOOSER_LIST_TAB,action:"list",content:this.resourcesListView,exposeAction:!0,additionalCssClasses:"action square small",i18n:g}],buttons:[{label:g.ADH_016_BUTTON_OK,action:"apply",primary:!0},{label:g.ADH_010_BUTTON_CANCEL,action:"cancel",primary:!1}]}),this.disableButton("apply"),this.on("button:apply",o.bind(this._onSelectDataDialogOkButtonClick,this)),this.on("button:cancel",o.bind(this._onSelectDataDialogCancelButtonClick,this))},prepareSpecificChooserDialog:function(){this.options.resourcesTypeToSelect&&this.options.resourcesTypeToSelect.length||(this.options.resourcesTypeToSelect=[T.REPORT_UNIT]);for(var e=[],t=0;t<this.options.resourcesTypeToSelect.length;t++)e.push("type="+this.options.resourcesTypeToSelect[t]);e=e.join("&"),L=L+"&"+e,w=w+"&"+e},initialize:function(e){this.listenTo(this.resourcesTreeView,"selection:change",this.selectionListener),this.listenTo(this.resourcesTreeView,"levelRenderError",o.bind(this._onLevelRenderError,this)),this.listenTo(this.resourcesTreeView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.resourcesListView,"selection:change",this.selectionListener),this.listenTo(this.resourcesListView,"levelRenderError",o.bind(this._onLevelRenderError,this)),this.listenTo(this.resourcesListView,"item:dblclick",this._onSelectDataDialogOkButtonClick),this.listenTo(this.resourcesListView.searchForm,"search",this._onSearch),this.listenTo(this.resourcesListView.searchForm,"clear",this._resetItemSelection),this.on("tab:tree tab:list",this._resetItemSelection,this),r.prototype.initialize.apply(this,arguments)},getErrorDialog:function(){return this.errorDialog?this.errorDialog:this.errorDialog=new n},events:{resize:"_onResizeHeight"},getContentHeight:function(){return this.$el.height()-this._resizableContainerShiftHeight-6},render:function(){return r.prototype.render.apply(this,arguments),this._dfdRenderSerachFormTo.resolve(this.$tabHeaderContainer),this.openTab(v),this},open:function(){var e=this;this._resizableContainerShiftHeight=6,r.prototype.open.apply(this,arguments);var t=o.bind(function(){this.$contentContainer.find(".tabContainer").css({height:"inherit","overflow-y":"auto"})},this);f.isIE8()||f.isIE9()?setTimeout(t,1):t(),this.$el.children().not(".subcontainer").not(".ui-resizable-e").not(".ui-resizable-se").each(function(){e._resizableContainerShiftHeight+=e.$(this).outerHeight(!0)}),this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight)},close:function(){this.resourcesTreeView&&(this.resourcesTreeView.collapse("@fakeRoot",{silent:!0}),this.resourcesTreeView.collapse("/public",{silent:!0}),this.resourcesTreeView.resetSelection()),r.prototype.close.apply(this,arguments)},selectionListener:function(e){var t=o.find(this.buttons.options,function(e){return"apply"===e.model.attributes.action}).$el,i=e&&o.isArray(e)&&e[0],s=i?e[0].uri:void 0,r=i?e[0].resourceType:void 0;return i||s||r?(r===T.FOLDER?this.$(".itemDescription").empty():this.$(".itemDescription").text(i.description||""),t.find(".wrap").text(g.ADH_016_BUTTON_OK),o.contains(o.union([T.FOLDER]),r)?(this.selectedResource=!1,void this.disableButton("apply")):(this.selectedResource={resourceUri:s,event:this._getAdHocFlowEvent(r)},void this.enableButton("apply"))):(this.disableButton("apply"),void this.$(".itemDescription").empty())},_onResizeHeight:function(){this.$contentContainer.height(this.$el.height()-this._resizableContainerShiftHeight),this.resourcesListView.rootLevel.list.$el.height(this.$el.height()-this._resizableContainerShiftHeight-6),this.resourcesTreeView.rootLevel.list.$el.css("height","100%")},_onSearch:function(){this.openTab(v),this.disableButton("apply")},_resetItemSelection:function(){this.resourcesTreeView.resetSelection(),this.resourcesListView.resetSelection(),this.$(".itemDescription").empty()},_getAdHocFlowEvent:function(e){var t="";return e==T.REPORT_UNIT||e==T.DOMAIN_TOPIC?t="startAdHocWithTopic":e==T.SEMANTIC_LAYER_DATA_SOURCE&&(t="startQueryBuilder"),t},_onSelectDataDialogOkButtonClick:function(){this.selectedResource&&this.close()},_onLevelRenderError:function(e,t,o){t=s.parse(t);var i=this.getErrorDialog();i.setMessage(t.parameters[0].substring(t.parameters[0].indexOf(": ")+2,t.parameters[0].indexOf("\n"))),i.open(),o.$el.removeClass(o.loadingClass).addClass(o.openClass)},_onSelectDataDialogCancelButtonClick:function(){this.selectedResource=!1,this.close()},_getParameterByName:function(e){var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),o=t.exec(location.search);return null==o?"":decodeURIComponent(o[1].replace(/\+/g," "))},remove:function(){this.resourcesTreeView.remove(),this.resourcesListView.remove(),r.prototype.remove.apply(this,arguments)}})});