define(["require","underscore","common/model/BaseModel","backbone.validation","common/validation/ValidationErrorMessage","common/enum/httpStatusCodes","common/transport/request","settings!globalConfiguration","common/enum/repositoryResourceTypes"],function(e){function t(e,t,r,n,o){return s({type:t,dataType:"json",url:e.contextPath+"/rest_v2/resources"+r+"?overwrite="+n+"&createFolders="+o,headers:{Accept:"application/json","Content-Location":e.get("uri")}}).done(function(t){e.set("uri",t.uri)})}var r=e("underscore"),n=e("common/model/BaseModel"),o=e("backbone.validation"),i=e("common/validation/ValidationErrorMessage"),s=(e("common/enum/httpStatusCodes"),e("common/transport/request")),a=e("settings!globalConfiguration"),d=(e("common/enum/repositoryResourceTypes"),100),u=100,l=250,c=/application\/repository\.([^\+]+)\+json/,p="<>",m="<>",h=a.resourceIdNotSupportedSymbols.slice(1,a.resourceIdNotSupportedSymbols.length-1),f=n.extend({idAttribute:"uri",type:void 0,urlRoot:function(){return(this.contextPath?this.contextPath+"/":"")+"rest_v2/resources"},defaults:{name:void 0,parentFolderUri:void 0,uri:void 0,label:void 0,description:void 0,permissionMask:void 0,creationDate:void 0,updateDate:void 0,version:void 0},validation:{name:[{required:!1},{maxLength:u,msg:new i("error.field.max.length","name",u)},{doesNotContainSymbols:h,msg:new i("error.field.bad.symbols","name",h)}],label:[{required:!0,msg:new i("error.field.required","label")},{maxLength:d,msg:new i("error.field.max.length","label",d)},{doesNotContainSymbols:p,msg:new i("error.field.bad.symbols","label",p)}],description:[{required:!1},{maxLength:l,msg:new i("error.field.max.length","description",l)},{doesNotContainSymbols:m,msg:new i("error.field.bad.symbols","description",m)}],parentFolderUri:[{required:!0,msg:new i("error.field.required","parentFolderUri")}]},url:function(){return this.isNew()?this.urlRoot()+this.get("parentFolderUri"):this.urlRoot()+this.id},constructor:function(e,t){t||(t={}),r.defaults(t,{parse:!0}),n.call(this,e,t)},initialize:function(e,t){this.contextPath=t.contextPath,t.type&&(this.type=t.type),this.on("change:parentFolderUri change:name",this._updateUri),this.on("change:uri",this._updateNameAndParentFolderUri),n.prototype.initialize.apply(this,arguments)},clone:function(){return new this.constructor(this.attributes,{contextPath:this.contextPath})},parse:function(e){return"undefined"!=typeof e.uri?(e.name=f.getNameFromUri(e.uri),e.parentFolderUri=f.getParentFolderFromUri(e.uri)):e.parentFolderUri&&e.name&&(e.uri=f.constructUri(e.parentFolderUri,e.name)),e},toJSON:function(){var e=this.serialize();return delete e.name,delete e.parentFolderUri,e},_updateUri:function(){var e=this.get("name"),t=this.get("parentFolderUri"),r=f.constructUri(t,e);r&&this.set("uri",r)},_updateNameAndParentFolderUri:function(){var e=this.get("uri"),t=f.getNameFromUri(e),r=f.getParentFolderFromUri(e);this.set({name:t,parentFolderUri:r})},fetch:function(e){return r.defaults(e||(e={}),{headers:{Accept:"application/json"}}),e.url=this.url()+"?expanded="+(e.expanded===!0),delete e.expanded,n.prototype.fetch.call(this,e)},sync:function(e,t,r){if("read"===e){var o=r.success,i=this;r.success=function(e,t,r){var n=r.getResponseHeader("Content-Type"),s=c.exec(n);if(!s||!s[1])throw new Error("Unsupported response content type: "+n);i.type=s[1],o&&o(e,t,r)}}return n.prototype.sync.call(this,e,t,r)},save:function(e,t,o){var i;if(r.isUndefined(e)||r.isNull(e)||r.isObject(e)?(i=e||{},o=t):(i={})[e]=t,!this.type)throw new Error("Resource type is unspecified. It's not possible to save a resource without it's type specified");return r.defaults(o||(o={}),{headers:{Accept:"application/json","Content-Type":"application/repository."+this.type+"+json; charset=UTF-8"}}),o.url=this.url()+"?createFolders="+(o.createFolders===!0),o.url+="&overwrite="+(o.overwrite===!0),o.url+="&expanded="+(o.expanded===!0),delete o.createFolders,delete o.overwrite,delete o.expanded,n.prototype.save.call(this,i,o)},isWritable:function(){var e=this.get("permissionMask"),t=!1;return r.isUndefined(e)||(t=1===e||4&e),t},copyTo:function(e,r,n){return t(this,"POST",e,!!r,arguments.length<3||n)},moveTo:function(e,r,n){return t(this,"PUT",e,!!r,arguments.length<3||n)}},{LABEL_MAX_LENGTH:d,NAME_MAX_LENGTH:u,DESCRIPTION_MAX_LENGTH:l,LABEL_NOT_SUPPORTED_SYMBOLS:p,DESCRIPTION_NOT_SUPPORTED_SYMBOLS:m,NAME_NOT_SUPPORTED_SYMBOLS:h,getNameFromUri:function(e){if(!e)return void 0;var t=e.split("/");return t[t.length-1]},getParentFolderFromUri:function(e){if(!e)return void 0;var t=e.split("/");return 2===t.length&&""!==t[1]?"/":t.slice(0,t.length-1).join("/")},constructUri:function(e,t){return t&&e?-1!==e.indexOf("/",e.length-1)?e+t:e+"/"+t:void 0},generateResourceName:function(e){var t="";return e&&(t=e.replace(new RegExp("["+f.NAME_NOT_SUPPORTED_SYMBOLS+"]","g"),"_")),t}});return r.extend(f.prototype,o.mixin),f});