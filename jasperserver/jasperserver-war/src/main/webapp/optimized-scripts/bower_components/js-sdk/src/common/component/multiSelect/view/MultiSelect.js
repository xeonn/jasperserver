define(["require","jquery","backbone","underscore","common/component/multiSelect/view/AvailableItemsList","common/component/multiSelect/view/SelectedItemsList","common/component/multiSelect/dataprovider/SelectedItemsDataProvider","text!common/component/multiSelect/templates/multiSelectTemplate.htm"],function(e){var t=e("jquery"),i=e("backbone"),s=e("underscore"),a=e("common/component/multiSelect/view/AvailableItemsList"),l=e("common/component/multiSelect/view/SelectedItemsList"),n=e("common/component/multiSelect/dataprovider/SelectedItemsDataProvider"),o=e("text!common/component/multiSelect/templates/multiSelectTemplate.htm"),r=100,c=i.View.extend({initialize:function(e){this.template=s.template(o),this.availableItemsList=this._createAvailableItemsList(e),this.selectedItemsDataProvider=this._createSelectedItemsListDataProvider(e),this.selectedItemsList=this._createSelectedItemsList(e),this.initListeners(),"undefined"!=typeof e.value&&(this.silent=!0,this.availableItemsList.setValue(e.value)),this.render()},_createAvailableItemsList:function(e){return e.availableItemsList||new a({getData:e.getData,bufferSize:e.bufferSize,loadFactor:e.loadFactor,chunksTemplate:e.chunksTemplate,scrollTimeout:e.scrollTimeout})},_createSelectedItemsListDataProvider:function(e){return this.selectedItemsDataProvider=new n({getData:e.getData})},_createSelectedItemsList:function(e){return new l({getData:this.selectedItemsDataProvider.getData,bufferSize:e.bufferSize,loadFactor:e.loadFactor,chunksTemplate:e.chunksTemplate,scrollTimeout:e.scrollTimeout,visibleItemsCount:e.visibleItemsCount})},initListeners:function(){this.listenTo(this.availableItemsList,"selection:change",this.selectionChange,this),this.listenTo(this.availableItemsList,"expand",this.onExpand,this),this.listenTo(this.availableItemsList,"collapse",this.onCollapse,this),this.listenTo(this.selectedItemsList,"selection:remove",this.selectionRemoved,this)},render:function(){this.availableItemsList.undelegateEvents(),this.selectedItemsList.undelegateEvents();var e=t(this.template({isIPad:"iPad"===navigator.platform}));return this.availableItemsList.render(),this.selectedItemsList.render(),e.append(this.availableItemsList.el),e.append(this.selectedItemsList.el),this.$el.empty(),this.$el.append(e),this.availableItemsList.delegateEvents(),this.selectedItemsList.delegateEvents(),this},selectionChange:function(e){clearTimeout(this.selectionChangeTimeout),this.selectionChangeTimeout=setTimeout(s.bind(this.selectionChangeInternal,this,e),r)},selectionRemoved:function(e){var t=this.selectedItemsDataProvider.getReverseIndexMapping(),i=this.availableItemsList.getValue(),s={};for(var a in i)if(i.hasOwnProperty(a)){var l=t?t[a]:a;if(void 0!==l&&void 0===e[l]){var n=i[a];void 0!==n&&(s[a]=n)}}this.availableItemsList.setValue(s)},onExpand:function(){this.selectedItemsList.$el.addClass("disabled"),this.trigger("expand")},onCollapse:function(){this.selectedItemsList.$el.removeClass("disabled"),this.trigger("collapse")},selectionChangeInternal:function(e){var t=this;this.selectedItemsDataProvider.setSelectedData(e),this.selectedItemsList.fetch(function(){t.selectedItemsList.resize()}),this.silent?delete this.silent:this.triggerSelectionChange()},triggerSelectionChange:function(){this.trigger("selection:change",this.getValue())},renderData:function(){return this.availableItemsList.renderData(),this.selectedItemsList.renderData(),this},fetch:function(e,t){this.availableItemsList.fetch(e,t)},reset:function(e){this.availableItemsList.reset(e)},setValue:function(e,t){t&&t.silent&&(this.silent=!0),delete t.silent,this.availableItemsList.setValue(e,t)},getValue:function(){var e=this.availableItemsList.getValue(),t=[],i=0;for(var s in e)e.hasOwnProperty(s)&&void 0!==e[s]&&(t[i++]=e[s]);return t},setDisabled:function(e){return this.availableItemsList.setDisabled(e),this.selectedItemsList.setDisabled(e),this},getDisabled:function(){return this.availableItemsList.getDisabled()},remove:function(){this.availableItemsList.remove(),this.selectedItemsList.remove(),i.View.prototype.remove.call(this)}});return c});