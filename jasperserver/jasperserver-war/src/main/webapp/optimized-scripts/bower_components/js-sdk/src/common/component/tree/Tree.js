define(["require","jquery.ui","underscore","jquery","backbone","./TreeLevel","./TreeDataLayer","text!./template/treeLevelListTemplate.htm","text!./template/treeLevelTemplate.htm"],function(e){function t(e){var s=e.list.model.get("items"),o=this;s=i.where(s,{_node:!0}),e.$(".node").each(function(n,l){var a=s[n].id;e.items[a]?e.items[a].setElement(l):(e.items[a]=new r(i.extend({},o._options,{el:l,id:s[n].id,resource:s[n].value,parent:e})),o.listenTo(e.items[a],"listRenderError",i.bind(function(e,t,i){this.trigger("levelRenderError",e,t,i)},o)),e.listenTo(e.items[a],"ready",i.bind(t,o)),e.listenTo(e.items[a],"selection:change",function(t,i,s){i&&s.push(i),e.list.model.clearSelection(),e.trigger("selection:change",t,e,s)}),e.listenTo(e.items[a],"item:dblclick",function(t){e.list.model.clearSelection(),e.trigger("item:dblclick",t)}),e.items[a].render())}).length&&e.$(".viewPortChunk").css({height:"auto"})}e("jquery.ui");var i=e("underscore"),s=(e("jquery"),e("backbone")),r=e("./TreeLevel"),o=e("./TreeDataLayer"),n=e("text!./template/treeLevelListTemplate.htm"),l=e("text!./template/treeLevelTemplate.htm"),a=s.View.extend({template:i.template(l),el:function(){return this.template()},constructor:function(e){e||(e={}),this.defaultDataLayer=new o(e),this.customDataLayers=e.customDataLayers,e.collapserSelector||(e.collapserSelector="b.icon:eq(0)"),e.predefinedData?(this.defaultDataLayer.predefinedData=e.predefinedData,e.predefinedData=void 0):this.defaultDataLayer.predefinedData={},e.rootless&&(this.rootless=e.rootless,e.rootless=void 0),e.additionalCssClasses&&(this.additionalCssClasses=e.additionalCssClasses,e.additionalCssClasses=void 0),e.getDataLayer&&(this.getDataLayer=e.getDataLayer,e.getDataLayer=void 0),this._options=i.extend({itemsTemplate:n,plugins:this._plugins,owner:this},e),this.context=e.context||{};for(var t=0,r=this._plugins.length;r>t;t++)this._plugins[t].processors&&(this.processors=this.processors.concat(this._plugins[t].processors));s.View.apply(this,arguments)},initialize:function(e){this.rootLevel=new r(i.extend({},this._options,{levelHeight:e.rootLevelHeight},{id:"/",el:this.$("li")[0],resource:{id:"/",resourceType:"folder"}})),this.rootless&&this.$el.find("ul:first").addClass("hideRoot"),this.additionalCssClasses&&this.$el.find("ul:first").addClass(this.additionalCssClasses),this.listenTo(this.rootLevel,"ready",i.bind(t,this)),this.listenTo(this.rootLevel,"selection:change",i.bind(function(e,t,s){t&&s&&i.isArray(s)&&(this.rootLevel.selection.multiple||this.rootLevel.resetSelection({silent:!0,exclude:[s[0]]})),this.trigger("selection:change",e)},this)),this.listenTo(this.rootLevel,"item:dblclick",i.bind(function(e){this.trigger("item:dblclick",e)},this));for(var s=0,o=this._plugins.length;o>s;s++)this._plugins[s].constr.treeInitialized.call(this,this._plugins[s].options);this.rootLevel.render(),e.collapsed&&e.lazyLoad&&this.rootless&&this.expand("/")},remove:function(){for(var e=0,t=this._plugins.length;t>e;e++)this._plugins[e].constr.treeRemoved.call(this);this.rootLevel.remove(),s.View.prototype.remove.apply(this,arguments)},expand:function(e,t){var i=this.getLevel(e);return i&&i.open(t),this},collapse:function(e,t){var i=this.getLevel(e);return i&&i.close(t),this},select:function(){},deselect:function(){},addItem:function(e,t){var i=this.getLevel(e);if(i){var s=this.getDataLayer(i);s.predefinedData[e]=i.list.model.get("items")?i.list.model.get("items"):[],s.predefinedData[e].push(t),i.list.lazy=!1,i.list.fetch()}return this},resetSelection:function(e){return this.rootLevel.list.clearSelection(),this.rootLevel.list.model.selection=[],this.rootLevel.resetSelection(e),this},refresh:function(e){e&&(this.context=e),this.rootLevel.refresh()},recalcConstraints:function(){this.rootLevel.recalcConstraints()},fetchVisibleData:function(){this.rootLevel.fetchVisibleData()},clearCache:function(){this.rootLevel.clearCache()},getLevel:function(e){return this.rootLevel.id===e?this.rootLevel:this.rootLevel.getLevel(e)},getDataLayer:function(e){return this.customDataLayers&&this.customDataLayers[e.id]?this.customDataLayers[e.id]:this.defaultDataLayer}},{_plugins:[],instance:function(e){return new this(e)}});return{use:function(e,t){return function(e){return{use:function(t,i){return e.prototype._plugins.push({constr:t,options:i}),this},create:function(){return e}}}(a.extend({_plugins:[{constr:e,options:t}]}))},create:function(){return a}}});