define(["require","jquery","backbone","underscore","common/component/singleSelect/manager/KeyboardManager","common/component/multiSelect/view/ListViewForSelectedItemsList","common/component/list/model/ListWithSelectionModel","common/component/list/model/listWithNavigationModelTrait","text!common/component/multiSelect/templates/selectedItemsListTemplate.htm","text!common/component/multiSelect/templates/selectedItemsTemplate.htm","text!common/component/multiSelect/templates/listTemplate.htm"],function(e){var t=e("jquery"),i=e("backbone"),s=e("underscore"),o=e("common/component/singleSelect/manager/KeyboardManager"),n=e("common/component/multiSelect/view/ListViewForSelectedItemsList"),l=e("common/component/list/model/ListWithSelectionModel"),a=e("common/component/list/model/listWithNavigationModelTrait"),d=e("text!common/component/multiSelect/templates/selectedItemsListTemplate.htm"),h=e("text!common/component/multiSelect/templates/selectedItemsTemplate.htm"),c=e("text!common/component/multiSelect/templates/listTemplate.htm"),u=i.View.extend({attributes:{"class":"svList"},events:function(){return{"keydown input":this.keyboardManager.onKeydown,"focus input":"onFocus","blur input":"onBlur","mouseup li .mSelect-svList-button":"onMouseupOnDeleteButton",mousedown:"onMousedown",mouseup:"onMouseup"}},keydownHandlers:s.extend({65:"onAKey",8:"onDeleteKey",46:"onDeleteKey"},o.prototype.keydownHandlers),initialize:function(e){s.bindAll(this,"onGlobalMouseup","onGlobalMousedown","onGlobalMousemove"),this.model||(this.model=new i.Model),this.model.set("focused",!1,{silent:!0}),this.template=s.template(d),this.keyboardManager=new o({keydownHandlers:this.keydownHandlers,keydownTimeout:e.keydownTimeout,context:this,deferredKeydownHandler:this.processKeydown,immediateHandleCondition:this.immediateHandleCondition,immediateKeydownHandler:this.immediateKeydownHandler,stopPropagation:!0});var u=l.extend(a);this.listViewModel=e.listViewModel||new u({getData:e.getData,bufferSize:e.bufferSize,loadFactor:e.loadFactor}),this.listView=e.listView||new n({el:e.listElement||t(c),model:this.listViewModel,chunksTemplate:e.chunksTemplate,itemsTemplate:e.itemsTemplate||h,scrollTimeout:e.scrollTimeout,lazy:!0,visibleItemsCount:e.visibleItemsCount,selection:{allowed:!0,multiple:!0}}),this.listView.setCanActivate(!1),this.initListeners(),this.render().resize()},initListeners:function(){this.listenTo(this.listView,"active:changed",this.activeChange,this),this.listenTo(this.model,"change:focused",this.focusStateChanged,this),this.listenTo(this.model,"change:disabled",this.changeDisabled,this),t("body").on("mousedown",this.onGlobalMousedown).on("mouseup",this.onGlobalMouseup).on("mousemove",this.onGlobalMousemove)},render:function(){this.listView.undelegateEvents();var e=t(this.template({disabled:this.model.get("disabled")}));return e.append(this.listView.el),this.$el.empty(),this.$el.append(e),this.listView.delegateEvents(),this},renderData:function(){return this.listView.renderData(),this},activeChange:function(e){e&&(this.activeChangedWithShift&&(delete this.activeChangedWithShift,this.listViewModel.addRangeToSelection(e.value,e.index)),this.listView.scrollTo(e.index))},changeDisabled:function(){var e=this.model.get("disabled");e?(this.$el.addClass("disabled"),this.$el.find("input[type='text']").attr("disabled","disabled"),this.listView.setValue({}),this.listView.activate(void 0)):(this.$el.find("input[type='text']").removeAttr("disabled"),this.$el.removeClass("disabled")),this.listView.setDisabled(e)},focusStateChanged:function(){this.model.get("focused")?(this.$el.find(".mSelect-svListPlaceholder").addClass("focused"),this.listView.setCanActivate(!0),this._activateFirstSelectedItem()):(this.$el.find(".mSelect-svListPlaceholder").removeClass("focused"),this.listView.setValue({}),this.listView.activate(void 0),this.listView.setCanActivate(!1))},onFocus:function(){this.model.set("focused",!0)},onBlur:function(){this.preventBlur||this.model.set("focused",!1)},onMouseupOnDeleteButton:function(e){this.onDeleteKey(e)},onMousedown:function(){this.preventBlur=!0,this.model.get("focused")||this.$el.find("input").focus()},onMouseup:function(){this.preventBlur&&(this.$el.find("input").focus(),delete this.preventBlur)},onGlobalMousedown:function(e){if(this.preventBlur){if(e.target===this.$el||this.$el.find(e.target).length>0)return;delete this.preventBlur,this.onBlur()}},onGlobalMouseup:function(){this.onMouseup()},onGlobalMousemove:function(e){this.preventBlur&&e.stopPropagation()},onUpKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.activatePrevious()},onDownKey:function(e){var t=this.listView.getActiveValue();t?(e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.activateNext()):this.listView.activateFirst()},onEnterKey:function(e){e.preventDefault();var t=this.listView.getActiveValue();e.shiftKey?this.listViewModel.addRangeToSelection(t.value,t.index):e.ctrlKey||e.metaKey?(this.listViewModel.clearSelection(),this.listViewModel.addValueToSelection(t.value,t.index)):this.listViewModel.toggleSelection(t.value,t.index)},onHomeKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.activateFirst()},onEndKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.activateLast()},onPageUpKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.pageUp()},onPageDownKey:function(e){e.shiftKey&&(this.activeChangedWithShift=!0),this.listView.pageDown()},onTabKey:function(){},onAKey:function(e){(e.ctrlKey||e.metaKey)&&(e.stopPropagation(),this.listView.selectAll())},onDeleteKey:function(){var e=this.listView.getValue();if(e&&e.length>0){var t=!0;for(var i in e)if(e.hasOwnProperty(i)&&void 0!==e[i]){t=!1;break}t||this.trigger("selection:remove",e)}},_activateFirstSelectedItem:function(){var e=this.listView.getValue();for(var t in e)if(e.hasOwnProperty(t)&&void 0!==e[t]){this.listViewModel.activate(parseInt(t,10),{silent:!0});break}},fetch:function(e,t){this.listView.setValue({}),this.listView.activate(void 0),this.listView.fetch(e,t)},resize:function(){this.listViewModel.get("items")&&0!==this.listViewModel.get("items").length?(this.$el.show(),this.listView.resize()):this.$el.hide()},setDisabled:function(e){this.model.set("disabled",e)},getDisabled:function(){return this.model.get("disabled")},remove:function(){this.listView.remove(),i.View.prototype.remove.call(this),t("body").off("mousedown",this.onGlobalMousedown).off("mouseup",this.onGlobalMouseup).off("mousemove",this.onGlobalMousemove)}});return u});