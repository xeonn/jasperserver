define(["require","exports","module","underscore","jquery","logger","domReady","backbone","common/util/domUtil"],function(t,e,n){var o=t("underscore"),i=t("jquery"),r=t("logger").register(n),a=(t("domReady"),t("backbone")),s=t("common/util/domUtil");return a.View.extend({overlayDOMObject:[],$overlayHolder:!1,scaleFactor:1,savedExternalContainersOverflow:!1,initialize:function(t){this.propertiesModel=t.propertiesModel,this.setExternalContainer(t.externalContainer),this.setBiComponentContainer(t.biComponentContainer),this.setBiComponent(t.biComponent),this.setScaleFactor(t.scaleFactor)},setExternalContainer:function(t){this.$externalContainer=i(t)},setBiComponentContainer:function(t){this.$biComponentContainer=i(t)},setBiComponent:function(t){this.$biComponent=i(t)},setScaleFactor:function(t){o.isUndefined(t)||(this.scaleFactor=t)},applyScale:function(t){o.isUndefined(t)||(this.scaleFactor=t,this._applyScaleTransform())},show:function(){return this.$biComponentContainer.length<1?void r.debug("loading overlay: external container is absent"):0==this.$biComponentContainer.height()||0==this.$biComponentContainer.width()?void r.debug("loading overlay: component container has zero size"):this.propertiesModel.get("isolateDom")&&!this.$biComponent.height()?void r.debug("iframe mode: bi component hasn't any size"):(this._buildOverlay(),this._attachToContainer(),this.hideScrollBarOnContainer(),this._adjustOverlaySizeAndPosition(),this._applyScaleTransform(),void this.$overlayHolder.show())},hide:function(){this.$overlayHolder&&this.$overlayHolder.hide(),this.showScrollBarOnContainer()},showScrollBarOnContainer:function(){this.savedExternalContainersOverflow===!0&&(this.$externalContainer.css("overflow-x",this.savedExternalContainerOverflowValueX),this.$externalContainer.css("overflow-y",this.savedExternalContainerOverflowValueY),this.savedExternalContainersOverflow=!1)},hideScrollBarOnContainer:function(){if(this.savedExternalContainersOverflow===!1){var t=s.hasScrollBar(this.$externalContainer[0],"vertical")||s.hasScrollBar(this.$externalContainer[0],"horizontal");t&&(this.savedExternalContainerOverflowValueX=this.$externalContainer.css("overflow-x"),this.savedExternalContainerOverflowValueY=this.$externalContainer.css("overflow-y"),this.savedExternalContainersOverflow=!0,this.$externalContainer.css("overflow-x","hidden"),this.$externalContainer.css("overflow-y","hidden"))}},remove:function(){return this.hide(),a.View.prototype.remove.call(this)},_buildOverlay:function(){0==this.overlayDOMObject.length&&0==this.overlayDOMObject.length&&(this.overlayDOMObject=i("<div>Loading...</div>").css({position:"absolute",top:20,left:0,width:"100%",color:"#fff","text-align":"center"}))},_attachToContainer:function(){this.$overlayHolder&&this.$overlayHolder.remove(),this.$overlayHolder=i("<div></div>").append(i("<div></div>").css({width:"100%",height:"100%",filter:"alpha(opacity=40)",opacity:".4","background-color":"black"})),this.$overlayHolder.append(this.overlayDOMObject),this.$overlayHolder.prependTo(this.$biComponentContainer)},_adjustOverlaySizeAndPosition:function(){var t,e,n=0,i=0,a={padding:{left:0,top:0,right:0,bottom:0},innerHeight:this.$externalContainer.innerHeight(),innerWidth:this.$externalContainer.innerWidth(),outerHeight:this.$externalContainer.outerHeight(),outerWidth:this.$externalContainer.outerWidth(),scrollHeight:this.$externalContainer[0].scrollHeight,scrollWidth:this.$externalContainer[0].scrollWidth,scrollTop:this.$externalContainer.scrollTop(),scrollLeft:this.$externalContainer.scrollLeft()};a.padding.top=parseInt(this.$externalContainer.css("paddingTop"),10),o.isNaN(a.padding.top)&&(a.padding.top=0),a.padding.right=parseInt(this.$externalContainer.css("paddingRight"),10),o.isNaN(a.padding.right)&&(a.padding.right=0),a.padding.bottom=parseInt(this.$externalContainer.css("paddingBottom"),10),o.isNaN(a.padding.bottom)&&(a.padding.bottom=0),a.padding.left=parseInt(this.$externalContainer.css("paddingLeft"),10),o.isNaN(a.padding.left)&&(a.padding.left=0),a.scrollWidth<=a.outerWidth?(r.debug("width: biComponent is smaller than container or equal OR container doesn't have horizontal scroll bars"),t=a.innerWidth-(a.padding.left+a.padding.right),i=a.scrollLeft):(r.debug("width: biComponent is larger than container"),i=a.scrollLeft-(a.scrollLeft<a.padding.left?0:a.padding.left),t=a.innerWidth+a.padding.right,a.scrollLeft+a.outerWidth>=a.scrollWidth-a.padding.right&&(r.debug("width: scrolled to the end"),t=a.innerWidth)),a.scrollHeight<=a.outerHeight?(r.debug("height: biComponent is smaller than container or equal OR container doesn't have vertical scroll bars"),e=a.innerHeight-(a.padding.top+a.padding.bottom),n=a.scrollTop):(r.debug("height: biComponent is larger than container"),n=a.scrollTop-(a.scrollTop<a.padding.top?0:a.padding.top),e=a.innerHeight+a.padding.bottom,a.scrollTop+a.outerHeight>=a.scrollHeight-a.padding.bottom&&(r.debug("height: scrolled to the end"),e=a.innerHeight)),this.$overlayHolder.css({position:"absolute",top:n,left:i,"z-index":495,width:t/this.scaleFactor,height:e/this.scaleFactor,display:"none"})},_applyScaleTransform:function(){var t="scale("+this.scaleFactor+")",e="top left",n={"-webkit-transform":t,"-moz-transform":t,"-ms-transform":t,"-o-transform":t,filter:"progid:DXImageTransform.Microsoft.Matrix(M11="+this.scaleFactor+", M12=0, M21=0, M22="+this.scaleFactor+", SizingMethod='auto expand')",transform:t,"-webkit-transform-origin":e,"-moz-transform-origin":e,"-ms-transform-origin":e,"-o-transform-origin":e,"transform-origin":e};this.$overlayHolder&&this.$overlayHolder.css(n)}})});