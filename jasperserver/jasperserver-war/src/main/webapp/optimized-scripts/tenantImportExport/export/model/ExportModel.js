define(["require","jquery","underscore","backbone","backbone.validation","bundle!ImportExportValidationBundle","common/util/i18nMessage","common/model/BaseModel","../model/ResourcesModel","tenantImportExport/export/factory/exportModelAttributesFactory","tenantImportExport/export/enum/exportTypesEnum"],function(e){function t(e){var t,r,s=[];return e.get("everything")?(s.push("everything"),e.get("includeAccessEvents")&&s.push("include-access-events")):(t=n(e)&&e.get("includeRepositoryPermissions")&&!i.isEmpty(e.get("uris")),r=!e.get("includeAttributeValues")||!e.get("includeAttributes"),e.get("userForRoles")&&s.push("role-users"),e.get("rolesForUser")&&s.push("users-roles"),t&&s.push("repository-permissions"),!e.get("includeSubOrganizations")&&s.push("skip-suborganizations"),e.get("includeAttributes")&&s.push("include-attributes"),r&&s.push("skip-attribute-values"),e.get("includeServerSettings")&&s.push("include-server-settings"),(!n(e)||!e.get("includeDependentObjects"))&&s.push("skip-dependent-resources")),e.get("includeAuditEvents")&&s.push("include-audit-events"),e.get("includeMonitoringEvents")&&s.push("include-monitoring-events"),e.get("encryptFile")&&s.push("encrypted"),s}function r(e){var t=[],r=new s.Deferred;return!e.get("everything")&&n(e)?e.resources.fetch().done(function(n){for(var s in m)e.get(s)&&t.push(n[m[s]]);r.resolve(i.flatten(t))}):r.resolve(null),r}function n(e){var t=i.keys(m);return i.filter(t,function(t){return e.get(t)}).length}var s=e("jquery"),i=e("underscore"),o=e("backbone"),u=e("backbone.validation"),l=e("bundle!ImportExportValidationBundle"),a=e("common/util/i18nMessage").extend({bundle:l}),d=e("common/model/BaseModel"),c=e("../model/ResourcesModel"),p=e("tenantImportExport/export/factory/exportModelAttributesFactory"),h=e("tenantImportExport/export/enum/exportTypesEnum"),g=256,m={includeReports:"report",includeDomains:"domain",includeAdHocViews:"adhocDataView",includeDataSources:"dataSource",includeDashboards:"dashboard",includeOtherResourceFiles:"others"},f=d.extend({defaults:{uris:["/"],fileName:"export.zip",encryptFile:!1,includeRepositoryPermissions:!0,includeScheduledReportJobs:!0},validation:{fileName:[{required:!0,msg:new a("export.file.name.empty")},{maxLength:g,msg:new a("export.file.name.too.long",g)},{fn:function(e){return/[\\/?*%:|"<>]/g.test(e)?new a("export.file.name.contains.not.supported.characters"):/^[\.]{1,2}$/g.test(e)?new a("export.file.name.not.valid"):void 0}}],uris:[{fn:function(){var e=this.toExportTask();return!(e.uris||e.roles||e.users||i.filter(e.parameters,function(e){return"role-users"!==e&&"users-roles"!==e}).length)}}]},initialize:function(){d.prototype.initialize.call(this),i.bindAll(this),this.resources=new c},url:function(){return"rest_v2/export"},save:function(){var e=new s.Deferred,t=new o.Model,n=this;t.url=this.url;var u={};return r(this).done(function(r){r&&(u.resourceTypes=r),t.save(i.extend(n.toExportTask(),u)).done(function(t){e.resolve(t)}).fail(function(t){e.reject(t),n.trigger("error",n,t)})}),e},cancel:function(){var e=this.url()+"/"+this.id;this.destroy({url:e})},toExportTask:function(){var e=this.get("everything"),r=this.get("roles"),s=this.get("users"),o=i.clone(this.get("uris")),u=e||this.get("includeReports")&&this.get("includeScheduledReportJobs"),l={uris:o,scheduledJobs:this.get("includeScheduledReportJobs")?o:null,parameters:this.get("includeRepositoryPermissions")?["repository-permissions"]:[]},a={uris:n(this)?o:null,roles:i.isEmpty(r)?null:r,users:i.isEmpty(s)?null:s,scheduledJobs:u?o:null,organization:this.get("organization"),parameters:t(this)};return this.type!==h.REPOSITORY?a:l},reset:function(e,t){this.type=t;var r=i.extend({},this.defaults,p(t));this.clear().set(i.extend({},r,e))}});return i.extend(f.prototype,u.mixin),f});