define(["require","css!importExport","jquery","underscore","backbone","../model/ExportModel","../model/ExportStateModel","../model/AuthorityPickerModel","./AuthorityPickerView","./LoadingDialog","./ExportDependentResourcesDialogView","common/component/notification/Notification","common/view/mixin/epoxyViewMixin","tenantImportExport/export/factory/exportTemplateFactory","tenantImportExport/export/enum/exportTypesEnum","bundle!ImportExportBundle","bundle!CommonBundle"],function(e){"use strict";function t(e){this.rolesList=new d({model:a.instance("rest_v2/{{#tenantId}}organizations/{{{tenantId}}}/{{/tenantId}}roles?q={{{searchString}}}{{#excludeSubOrgs}}&includeSubOrgs=false{{/excludeSubOrgs}}",{tenantId:e.tenantId}),customClass:"selectedRoles",title:R["export.dialog.roles.users.roles.label"],selectLabel:R["export.dialog.roles.users.select.all.roles.label"]}),this.rolesList.on("change:selection",this.bindWithRoles),this.rolesList.render(),this.usersList=new d({model:a.instance("rest_v2/{{#tenantId}}organizations/{{{tenantId}}}/{{/tenantId}}users?q={{{searchString}}}{{#excludeSubOrgs}}&includeSubOrgs=false{{/excludeSubOrgs}}",{tenantId:e.tenantId}),customClass:"select selectedUsers",title:R["export.dialog.roles.users.users.label"],selectLabel:R["export.dialog.roles.users.select.all.users.label"]}),this.usersList.on("change:selection",this.bindWithUsers),this.usersList.render(),this.rolesToUsers=a.instance("rest_v2/users?hasAllRequiredRoles=false{{#roles}}&requiredRole={{{.}}}{{/roles}}"),this.rolesToUsers.on("change",this.onRolesToUsersChange),this.usersToRoles=a.instance("rest_v2/roles?hasAllUsers=false{{#users}}&user={{{.}}}{{/users}}"),this.usersToRoles.on("change",this.onUsersToRolesChange),this.changeEnabledState(),this.listenTo(this.model,"change:everything",this.changeEnabledState),this.$el.find(".selectRolesUsers").append(this.rolesList.el).append(this.usersList.el),this.listenTo(this.model,"change:includeSubOrganizations",this.filterAuthoritiesBySubOrgs)}function s(){var e=document.createElement("iframe");e.src=this.model.url()+"/"+this.stateModel.id+"/"+this.model.get("fileName"),e.style.display="none",o("body").append(e)}function i(e){this.model.cancel(),this.stateModel.set("phase",e)}e("css!importExport");var o=e("jquery"),n=e("underscore"),r=e("backbone"),l=e("../model/ExportModel"),h=e("../model/ExportStateModel"),a=e("../model/AuthorityPickerModel"),d=e("./AuthorityPickerView"),c=e("./LoadingDialog"),u=e("./ExportDependentResourcesDialogView"),g=e("common/component/notification/Notification"),p=e("common/view/mixin/epoxyViewMixin"),m=e("tenantImportExport/export/factory/exportTemplateFactory"),f=e("tenantImportExport/export/enum/exportTypesEnum"),R=e("bundle!ImportExportBundle"),x=e("bundle!CommonBundle"),b=r.View.extend({className:"export-view",events:{"change .usersWithSelectedRoles":"includeRolesByUsers","change .rolesWithSelectedUsers":"includeUsersWithRoles","change .selectedUsersRoles":"includeSelectedRolesUsersOnly","click .section .checkBox label":"_clickOnCheckbox"},computeds:{includeAccessEventsChecked:function(){return this.model.get("everything")?this.model.get("includeAccessEvents"):!1},enableAttributesValues:{deps:["everything","includeAttributes"],get:function(e,t){return!e&&t}},enableReportJobs:{deps:["everything","includeReports"],get:function(e,t){return!e&&t}},someResourceIsChecked:{deps:["everything","includeReports","includeAdHocViews","includeDashboards","includeDomains","includeDataSources","includeOtherResourceFiles"],get:function(e,t,s,i,o,n,r){return!e&&(t||s||i||o||n||r)}}},initialize:function(){n.bindAll(this),this.model||(this.model=new l),this.stateModel=new h,this.epoxifyView(),this.loadingDialog=new c({content:x["dialog.overlay.loading"]}),this.notification=new g,this.dependentResourcesDialogView=new u,this.listenTo(this.model,"change",this._onModelChange),this.listenTo(this.stateModel,"change:phase",this.handleExportPhase,this),this.listenTo(this.model,"error:unauthorized",window.location.reload),this.listenTo(this.stateModel,"error:unauthorized",window.location.reload);var e={delay:!1,message:R["export.error.cancelled"]},t={delay:!1,message:R["export.error.unexpected"]};this.listenTo(this.model,"error:notFound",n.bind(this.notification.show,this.notification,e)),this.listenTo(this.stateModel,"error:notFound",n.bind(this.notification.show,this.notification,e)),this.listenTo(this.model,"error:internalServerError",n.bind(this.notification.show,this.notification,t)),this.listenTo(this.stateModel,"error:internalServerError",n.bind(this.notification.show,this.notification,t)),this.listenTo(this.model,"error",n.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.stateModel,"error",n.bind(this.loadingDialog.close,this.loadingDialog)),this.listenTo(this.dependentResourcesDialogView,"button:export",n.compose(n.bind(this.dependentResourcesDialogView.close,this.dependentResourcesDialogView),n.bind(function(){s.call(this),this._showNotification({message:R["export.finished"],type:"success"})},this))),this.listenTo(this.dependentResourcesDialogView,"button:cancel",n.bind(i,this,h.STATE.CANCELLED))},render:function(e){e=e||{},this.type=e.type;var s=this._isServerLevel(this.type),i=s||this.type===f.ROOT_TENANT;return i?this.$el.addClass("with-events"):this.$el.removeClass("with-events"),this.stopListening(this.model,"change:includeSubOrganizations",this.filterAuthoritiesBySubOrgs),this._resetModel(e),this.template=n.template(m(e))({everything:!1,i18n:R,isServerOrRootType:i,isServerLevel:s,isServerCe:this.type===f.SERVER_CE,isRepository:this.type===f.REPOSITORY}),this.$el.html(this.template),this.$(".selectRolesUsers").length&&t.call(this,e),this.applyEpoxyBindings(),this},doExport:function(){var e=this;this.model.isValid(!0)&&(this.loadingDialog.open(),this.model.save().done(function(t){e.stateModel.unset("brokenDependencies",{silent:!0}),e.stateModel.set(t),e.model.id=t.id}))},handleExportPhase:function(){var e,t=this.stateModel.get("phase"),i=this._getBrokenDependencies();t==h.STATE.READY&&(this.loadingDialog.close(),n.isEmpty(i)?(s.call(this),e={message:R["export.finished"],type:"success"}):this.dependentResourcesDialogView.open({items:i})),t==h.STATE.FAILED&&(e={message:R["export.error.unexpected"]}),t==h.STATE.CANCELLED&&(e={message:R["export.error.cancelled"]}),e&&this._showNotification(e)},filterAuthoritiesBySubOrgs:function(){var e={excludeSubOrgs:!this.model.get("includeSubOrganizations")};this.rolesList.model.setContext(e),this.usersList.model.setContext(e)},bindWithRoles:function(e){this.model.set({roles:e}),this.onUsersToRolesChange(),e.length?this.rolesToUsers.setContext({roles:e}):this.rolesToUsers.set({items:[]})},bindWithUsers:function(e){this.model.set({users:e}),this.onRolesToUsersChange(),e.length?this.usersToRoles.setContext({users:e}):this.usersToRoles.set({items:[]})},changeEnabledState:function(){var e=this.model.get("everything");this.rolesList.setDisabled(e||this.model.get("rolesForUser")),this.usersList.setDisabled(e||this.model.get("userForRoles")),e&&(this.rolesList.selectNone(),this.usersList.selectNone())},includeRolesByUsers:function(e){var t=o(e.target).is(":checked");this.model.set({rolesForUser:!t,userForRoles:t}),this.onRolesToUsersChange(),this._includeUsersOrRoles(!t,t)},includeUsersWithRoles:function(e){var t=o(e.target).is(":checked");this.model.set({rolesForUser:t,userForRoles:!t}),this.onUsersToRolesChange(),this._includeUsersOrRoles(t,!t)},includeSelectedRolesUsersOnly:function(e){o(e.target).is(":checked")&&(this.model.set({userForRoles:!1,rolesForUser:!1}),this.onRolesToUsersChange(),this.onUsersToRolesChange(),this._includeUsersOrRoles(!1,!1))},sendParameters:function(e){this.model.isValid(!0)&&this.model.save()},onRolesToUsersChange:function(){this.model.get("userForRoles")?(this.usersList.highlightSet(n.map(this.rolesToUsers.get("items"),function(e){return e.username+(e.tenantId?"|"+e.tenantId:"")})),this.rolesList.highlightSet([])):this.usersList.highlightSet([])},onUsersToRolesChange:function(){this.model.get("rolesForUser")?(this.rolesList.highlightSet(n.map(this.usersToRoles.get("items"),function(e){return e.name+(e.tenantId?"|"+e.tenantId:"")})),this.usersList.highlightSet([])):this.rolesList.highlightSet([])},_isServerLevel:function(e){return e===f.SERVER_CE||e===f.SERVER_PRO},_includeUsersOrRoles:function(e,t){this.rolesList.setDisabled(e),this.usersList.setDisabled(t),this.rolesList.selectNone(),this.usersList.selectNone()},_showNotification:function(e){e=n.defaults(e,{type:"warning"}),this.loadingDialog.isVisible()&&this.loadingDialog.close(),this.notification.show({delay:!1,message:e.message,type:e.type})},_getBrokenDependencies:function(){var e=this.stateModel.get("warnings"),t=[];return n.each(e,function(e){"export.broken.dependency"===e.code&&t.push(e.parameters)}),n.flatten(n.sortBy(t,function(e){return e}))},_clickOnCheckbox:function(e){var t=o(e.target).next();t[0].disabled||this.model.set(t[0].name,!t[0].checked)},_onModelChange:function(){this.model.isValid(!0)},_resetModel:function(e){var t={organization:this.type==f.REPOSITORY?null:e.tenantId};if(this.type===f.ROOT_TENANT||this.type===f.TENANT){var s=this.type===f.ROOT_TENANT?"root_export.zip":e.tenantId+"_export.zip";n.extend(t,{fileName:s})}this.model.reset(t,this.type)}});return n.extend(b.prototype,p),b});